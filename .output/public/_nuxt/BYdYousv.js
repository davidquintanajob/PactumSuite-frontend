import{r as d,M as K,N as z,y as u,z as s,A as y,F as _,K as E,L as N,O as H,P as q,H as P,B as $,V as B,n as j,q as R}from"#entry";const U={class:"relative"},G={class:"relative"},J=["placeholder","disabled"],Q={class:"absolute right-3 top-2.5"},W={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},X={key:1,class:"animate-spin h-5 w-5 text-gray-400",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Y={key:0,class:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},Z=["onMousedown"],ee=["innerHTML"],le={key:1},ae={key:1,class:"px-4 py-2 text-sm text-gray-500"},oe={__name:"SelectSearchAPI",props:{modelValue:{type:[String,Number,null],default:null},endpoint:{type:String,required:!0},method:{type:String,default:"POST"},searchKey:{type:String,required:!0},labelKey:{type:String,required:!0},valueKey:{type:String,required:!0},placeholder:{type:String,default:"Buscar..."},disabled:{type:Boolean,default:!1},directData:{type:Boolean,default:!1},labelFormat:{type:String,default:null},initialLabel:{type:String,default:""}},emits:["update:modelValue","entidad-seleccionada","producto-seleccionado"],setup(b,{emit:M}){const l=b,v=M,w=d(null),o=d(""),i=d(null),g=d(null),p=d(!1),f=d(!1),t=d(-1),h=d(null),r=d([]),V=j(),S=e=>e[l.valueKey],k=e=>{if(l.labelFormat){let a=l.labelFormat;return a=a.replace(/\{\{([^}]+)\}\}/g,(n,c)=>{const m=c.split(".");let x=e;for(const O of m)x=x?.[O];return x||""}),a}return e[l.labelKey]},A=async e=>{if(!e||e.trim()===""){r.value=[];return}const a=localStorage.getItem("token");if(!a){console.error("No hay token de autenticación");return}try{f.value=!0;const n={[l.searchKey]:e},c=await fetch(`${V.public.backendHost}${l.endpoint}`,{method:l.method,headers:{"Content-Type":"application/json",Authorization:a},body:l.method!=="GET"?JSON.stringify(n):void 0});if(c.status===401){console.error("Sesión expirada"),localStorage.removeItem("token"),localStorage.removeItem("user"),R("/");return}if(!c.ok)throw new Error(`Error en la búsqueda: ${c.status}`);const m=await c.json();l.directData?r.value=Array.isArray(m)?m:[]:r.value=m.data||[]}catch(n){console.error("Error al buscar:",n),r.value=[]}finally{f.value=!1}},D=()=>{if(h.value&&clearTimeout(h.value),o.value===""){i.value=null,g.value=null,v("update:modelValue",null),r.value=[];return}h.value=setTimeout(()=>{A(o.value)},1500)},F=()=>{p.value=!0,t.value=-1,o.value&&B(()=>{w.value?.select()})},L=()=>{setTimeout(()=>{p.value=!1,t.value=-1},200)},C=e=>{if(p.value)switch(e.key){case"ArrowDown":e.preventDefault(),t.value=Math.min(t.value+1,r.value.length-1);break;case"ArrowUp":e.preventDefault(),t.value=Math.max(t.value-1,-1);break;case"Enter":e.preventDefault(),t.value>=0&&r.value[t.value]&&T(r.value[t.value]);break;case"Escape":p.value=!1,t.value=-1;break}},T=e=>{i.value=S(e),g.value=e;const a=k(e);l.labelFormat?o.value=a.split(`
`)[0]:o.value=a,p.value=!1,t.value=-1,v("update:modelValue",i.value),l.valueKey==="id_entidad"&&v("entidad-seleccionada",e),l.valueKey==="id_producto"&&v("producto-seleccionado",e)},I=()=>{i.value=null,g.value=null,o.value="",p.value=!1,t.value=-1,r.value=[],v("update:modelValue",null),l.valueKey==="id_entidad"&&v("entidad-seleccionada",null),l.valueKey==="id_producto"&&v("producto-seleccionado",null),B(()=>{w.value?.focus()})};return K(()=>l.modelValue,e=>{e===null||e===""?(i.value=null,g.value=null,o.value=""):e&&!i.value&&(i.value=e)},{immediate:!0}),K(()=>l.initialLabel,e=>{e&&!o.value&&(o.value=e)},{immediate:!0}),z(()=>{h.value&&clearTimeout(h.value)}),(e,a)=>(s(),u("div",U,[y("div",G,[E(y("input",{ref_key:"inputRef",ref:w,"onUpdate:modelValue":a[0]||(a[0]=n=>o.value=n),type:"text",placeholder:b.placeholder,disabled:b.disabled,class:"w-full px-4 py-2 pr-10 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onFocus:F,onBlur:L,onInput:D,onKeydown:C},null,40,J),[[N,o.value]]),y("div",Q,[f.value?(s(),u("svg",X,[...a[2]||(a[2]=[y("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),y("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(s(),u("svg",W,[...a[1]||(a[1]=[y("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},null,-1)])]))])]),p.value&&(r.value.length>0||f.value)?(s(),u("div",Y,[i.value!==null&&i.value!==""&&!f.value?(s(),u("div",{key:0,class:"px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 cursor-pointer border-b",onMousedown:I}," Limpiar selección ",32)):_("",!0),(s(!0),u(H,null,q(r.value,(n,c)=>(s(),u("div",{key:S(n),class:P(["px-4 py-2 text-sm hover:bg-gray-100 cursor-pointer",{"bg-primary text-white":c===t.value}]),onMousedown:m=>T(n)},[l.labelFormat?(s(),u("div",{key:0,innerHTML:k(n).replace(/\n/g,"<br>")},null,8,ee)):(s(),u("div",le,$(k(n)),1))],42,Z))),128)),!f.value&&r.value.length===0&&o.value?(s(),u("div",ae," No se encontraron resultados ")):_("",!0)])):_("",!0)]))}};export{oe as _};
