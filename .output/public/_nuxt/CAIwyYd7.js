import{r as n,o as z,q as f,n as M,k as H,y as g,C as h,F as $,A as t,B as d,H as D,K as k,L as P,z as b}from"#entry";import{D as I}from"./DIpJa8iN.js";import{N as J}from"./DTHag2Fn.js";import{_ as q}from"./CP6NTKUH.js";import"./BzLCLO6P.js";const K={class:"min-h-screen bg-gradient-to-br via-secondary/40 from-accent/30 to-neutral flex flex-col items-center py-12"},G={key:0,class:"fixed top-6 left-1/2 transform -translate-x-1/2 z-[9999] w-full max-w-md px-4 pointer-events-none"},Q={class:"bg-white rounded-xl shadow-lg p-8 w-full max-w-lg mt-8"},W={key:0,class:"space-y-4"},X={class:"flex flex-col gap-2"},Y={class:"flex justify-between items-center"},Z={class:"text-gray-900"},ee={class:"flex justify-between items-center"},te={class:"text-gray-900"},ae={class:"flex justify-between items-center"},se={class:"text-gray-900"},oe={class:"flex justify-between items-center"},re={class:"text-gray-900"},ne={class:"flex justify-between items-center"},le={class:"text-gray-900"},ie={class:"flex justify-between items-center"},ue={class:"mt-6 border-t pt-6"},ce={class:"space-y-3"},de={class:"flex justify-end"},fe=["disabled"],me={key:0,class:"text-sm text-red-600"},pe={key:1,class:"text-center text-gray-500"},ge={class:"bg-white rounded-xl shadow-lg p-8 w-full max-w-3xl mt-8"},be={class:"bg-white rounded-xl shadow-lg p-8 w-full max-w-3xl mt-8"},Ce={__name:"perfil",setup(ve){const N=M(),l=n(null),w=n([]),j=n(1),v=n([]),A=n(1),y=n(!1),m=n(!1),x=n(""),u=n(""),c=n(""),i=n(null),S=[{key:"num_consecutivo",label:"Num. Consecutivo"},{key:"fecha",label:"Fecha",cellRenderer:a=>a?`<span class="px-2 py-1 rounded text-sm">${a.substring(0,10)}</span>`:""},{key:"estado",label:"Estado",cellRenderer:a=>{if(!a)return"";let e="";return a==="Facturado"?e="bg-green-100 text-green-800":a==="No Facturado"?e="bg-yellow-100 text-yellow-800":a==="Cancelado"&&(e="bg-red-100 text-red-800"),`<span class="px-2 py-1 rounded-full text-sm font-medium ${e}">${a}</span>`}},{key:"contrato.ClienteOProveedor",label:"Cliente o Proveedor",cellRenderer:a=>a?`<span class="px-2 py-1 rounded-full text-sm font-medium ${a==="Cliente"?"bg-blue-100 text-blue-800":"bg-orange-100 text-orange-800"}">${a}</span>`:""},{key:"contrato.num_consecutivo",label:"Contrato"},{key:"contrato.tipoContrato.nombre",label:"Tipo Contrato"},{key:"importe",label:"Importe",cellRenderer:a=>{if(a==null||a==="")return"";const e=parseFloat(a);return isNaN(e)?a:`<span class="px-2 py-1 rounded text-sm">${e.toFixed(2)}</span>`}}],O=[{key:"id_oferta",label:"ID Oferta"},{key:"descripcion",label:"Descripción"},{key:"fecha_inicio",label:"Fecha Inicio",format:a=>a?.substring(0,10)},{key:"fecha_fin",label:"Fecha Fin",format:a=>a?.substring(0,10)},{key:"id_contrato",label:"ID Contrato"}];function E(a){j.value=a}function V(a){A.value=a}z(async()=>{y.value=!0;try{const a=localStorage.getItem("usuario");if(!a){f("/login");return}let e;try{e=JSON.parse(a)}catch{f("/login");return}if(!e||!e.id_usuario){f("/login");return}const s=await(await fetch(`${N.public.backendHost}/usuario/${e.id_usuario}`)).json();l.value=s;const B=Array.isArray(s.facturas)?s.facturas:[];w.value=B.map(o=>{let _=o.totalFactura;if(_==null){const L=Array.isArray(o.servicio)?o.servicio.reduce((C,p)=>C+Number(p.importe)*Number(p.cantidad||1),0):0,U=Array.isArray(o.productos)?o.productos.reduce((C,p)=>C+Number(p.factura_producto?.precioVenta||0)*Number(p.factura_producto?.cantidad||0),0):0;_=L+U}return{...o,importe:_}}),v.value=Array.isArray(s.oferta)?s.oferta.map(o=>({...o,fecha_inicio:o.fecha_inicio?o.fecha_inicio.substring(0,10):"",fecha_fin:o.fecha_fin?o.fecha_fin.substring(0,10):""})):[]}catch{l.value=null,v.value=[]}finally{y.value=!1}});const F=H(()=>u.value.length>0&&c.value.length>0&&u.value===c.value);async function R(){try{m.value=!0;const a=localStorage.getItem("token");if(!a){f("/login");return}const e=await fetch(`${N.public.backendHost}/Usuario/changePassword`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:a,Accept:"application/json"},body:JSON.stringify({viejaContrasenna:x.value,nuevaContrasenna:u.value})});if([400,401,403,404,500].includes(e.status)){let r="Error al cambiar la contraseña";try{const s=await e.json();s&&Array.isArray(s.errors)?r=s.errors.join(`
`):s&&s.error&&(r=s.error)}catch{}i.value={title:"Error",description:r,type:"error"};return}if(!e.ok){i.value={title:"Error",description:"No se pudo cambiar la contraseña",type:"error"};return}i.value={title:"Éxito",description:"Contraseña cambiada correctamente",type:"success"},x.value="",u.value="",c.value=""}catch{i.value={title:"Error",description:"Ocurrió un error al cambiar la contraseña",type:"error"}}finally{m.value=!1}}function T(){try{localStorage.clear(),window.location.pathname==="/"?window.location.reload():f("/")}catch{f("/")}}return(a,e)=>(b(),g("div",K,[h(J),i.value?(b(),g("div",G,[h(q,{title:i.value.title,description:i.value.description,type:i.value.type,onClose:e[0]||(e[0]=r=>i.value=null),class:"pointer-events-auto"},null,8,["title","description","type"])])):$("",!0),t("div",Q,[t("div",{class:"flex justify-between items-center mb-6"},[e[4]||(e[4]=t("h2",{class:"text-2xl font-bold text-blue-700"},"Mi Perfil",-1)),t("button",{onClick:T,class:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500"}," Cerrar sesión ")]),l.value?(b(),g("div",W,[t("div",X,[t("div",Y,[e[5]||(e[5]=t("span",{class:"font-semibold text-gray-700"},"Nombre:",-1)),t("span",Z,d(l.value.nombre),1)]),t("div",ee,[e[6]||(e[6]=t("span",{class:"font-semibold text-gray-700"},"Usuario:",-1)),t("span",te,d(l.value.nombre_usuario),1)]),t("div",ae,[e[7]||(e[7]=t("span",{class:"font-semibold text-gray-700"},"Carnet de Identidad:",-1)),t("span",se,d(l.value.carnet_identidad),1)]),t("div",oe,[e[8]||(e[8]=t("span",{class:"font-semibold text-gray-700"},"Cargo:",-1)),t("span",re,d(l.value.cargo),1)]),t("div",ne,[e[9]||(e[9]=t("span",{class:"font-semibold text-gray-700"},"Rol:",-1)),t("span",le,d(l.value.rol),1)]),t("div",ie,[e[10]||(e[10]=t("span",{class:"font-semibold text-gray-700"},"Estado:",-1)),t("span",{class:D([l.value.activo?"bg-success":"bg-danger","px-3 py-1 rounded-full text-neutral text-xs font-semibold"])},d(l.value.activo?"Activo":"Inactivo"),3)])]),t("div",ue,[e[14]||(e[14]=t("h3",{class:"text-lg font-semibold text-blue-700 mb-4"},"Cambiar contraseña",-1)),t("div",ce,[t("div",null,[e[11]||(e[11]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Contraseña actual",-1)),k(t("input",{type:"password","onUpdate:modelValue":e[1]||(e[1]=r=>x.value=r),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Ingresa tu contraseña actual"},null,512),[[P,x.value]])]),t("div",null,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Nueva contraseña",-1)),k(t("input",{type:"password","onUpdate:modelValue":e[2]||(e[2]=r=>u.value=r),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Ingresa la nueva contraseña"},null,512),[[P,u.value]])]),t("div",null,[e[13]||(e[13]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Confirmar nueva contraseña",-1)),k(t("input",{type:"password","onUpdate:modelValue":e[3]||(e[3]=r=>c.value=r),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Confirma la nueva contraseña"},null,512),[[P,c.value]])]),t("div",de,[t("button",{onClick:R,disabled:m.value||!F.value,class:D(["px-6 py-2 rounded-lg transition-colors",!F.value||m.value?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-primary text-neutral hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"])},d(m.value?"Cambiando...":"Cambiar contraseña"),11,fe)]),u.value&&c.value&&u.value!==c.value?(b(),g("p",me,"Las nuevas contraseñas no coinciden.")):$("",!0)])])])):(b(),g("div",pe,"Cargando datos..."))]),t("div",ge,[e[15]||(e[15]=t("h3",{class:"text-xl font-semibold text-blue-700 mb-4"},"Facturas del usuario",-1)),h(I,{columns:S,items:w.value,"total-items":w.value.length,"items-per-page":10,"current-page":j.value,"is-loading":y.value,"show-actions":!1,onPageChange:E},null,8,["items","total-items","current-page","is-loading"])]),t("div",be,[e[16]||(e[16]=t("h3",{class:"text-xl font-semibold text-blue-700 mb-4"},"Ofertas del usuario",-1)),h(I,{columns:O,items:v.value,"total-items":v.value.length,"items-per-page":5,"current-page":A.value,"is-loading":y.value,"show-actions":!1,onPageChange:V},null,8,["items","total-items","current-page","is-loading"])])]))}};export{Ce as default};
