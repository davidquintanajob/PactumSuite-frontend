import{_ as ve,r as c,o as fe,k as O,q as U,n as xe,y as m,C as Z,A as e,F as Y,H as pe,X as ee,B as v,Y as ge,E as f,K as te,L as se,O as ae,P as oe,z as x}from"#entry";import{N as he}from"./DTHag2Fn.js";import{S as be}from"./CC2Sf2Ne.js";import"./BzLCLO6P.js";const ye={class:"min-h-screen bg-gradient-to-br via-secondary/40 from-accent/30 to-neutral"},_e={class:"w-[95%] mx-auto px-4 py-6 mt-20 md:mt-6"},we={class:"bg-white rounded-lg shadow-md p-4"},Se={class:"flex flex-col md:flex-row md:items-center md:gap-6 gap-4"},ke={class:"relative"},Ie={key:0,class:"absolute top-10 right-0 bg-white text-sm text-gray-700 p-2 rounded shadow w-56 z-20"},De={class:"mt-6 bg-white rounded-lg shadow-md p-6 h-[80vh] flex flex-col"},Te={class:"flex-1 border-2 border-dashed border-gray-200 rounded p-4 text-gray-400"},je={key:0,class:"flex flex-col md:flex-row items-center justify-center"},Fe={class:"w-full md:w-1/2 flex flex-col items-center justify-center p-4"},Me={key:0,class:"text-center"},Ae={key:1,class:"relative w-48 h-48 md:w-64 md:h-64 max-w-full"},Ee={key:0,class:"fixed inset-0 z-[20000] flex items-center justify-center bg-black/60"},Ce={class:"bg-white rounded-lg p-6 w-full max-w-lg mx-4"},$e={key:0},Ve={class:"w-full bg-gray-100 rounded h-3 overflow-hidden mb-3"},Ne={class:"text-sm text-gray-600"},Pe={key:1},Be={class:"text-sm text-gray-700 mb-4"},Re={class:"flex gap-2 justify-end"},Oe={class:"w-full md:w-1/2 p-4 overflow-hidden"},Ue={class:"flex flex-col gap-4"},ze={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},He={class:"font-semibold text-right"},Ge={class:"text-sm text-gray-500"},Ye={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},Le={class:"font-semibold text-right"},Je={class:"text-sm text-gray-500"},qe={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},Ke={class:"font-semibold text-right"},Xe={class:"text-sm text-gray-500"},Qe={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},We={class:"font-semibold text-right"},Ze={class:"text-sm text-gray-500"},et={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},tt={class:"font-semibold text-right"},st={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},at={class:"font-semibold text-right"},ot={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},nt={class:"font-semibold text-right"},lt={key:1,class:"w-full flex flex-col items-center justify-start p-4 gap-4"},rt={class:"w-full max-w-xl flex flex-col sm:flex-row gap-3 items-stretch"},it={class:"flex-1"},ct={class:"flex-1"},dt={class:"w-full mt-4"},ut={key:0,class:"text-center py-6"},mt={key:1,class:"text-center text-sm text-red-600"},vt={key:2,class:"text-center text-sm text-gray-600"},ft={key:3,class:"w-full overflow-auto"},xt={viewBox:"0 0 100 50",class:"w-full h-40"},pt=["points"],gt=["cx","cy"],ht={class:"mt-2 text-xs text-gray-600 flex flex-wrap gap-2"},L=5,bt={__name:"informes",setup(yt){const V=c(!1),ne=c(!1),j=c("A");function le(a){a.stopPropagation(),V.value=!V.value,V.value&&(ne.value=!1)}function re(a){a!==j.value&&(j.value=a,K())}const F=c(""),M=c(""),z=c(!1),h=c([]),N=c(null);function J(a){const t=a.getFullYear(),o=String(a.getMonth()+1).padStart(2,"0"),d=String(a.getDate()).padStart(2,"0");return`${t}-${o}-${d}`}function ie(){const a=new Date,t=new Date(a.getFullYear(),a.getMonth()-1,1),o=new Date(a.getFullYear(),a.getMonth(),0);F.value=J(t),M.value=J(o)}function ce(){N.value=null,h.value=[],z.value=!0,(async()=>{try{const a=new Date(F.value+"T00:00:00").toISOString(),t=new Date(M.value+"T23:59:59").toISOString(),o=localStorage.getItem("token"),d={fecha_hora_min:a,fecha_hora_max:t},l=await fetch(`${I.public.backendHost}/Venta/filter/1/999999999`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:o},body:JSON.stringify(d)});if(l.status===401){localStorage.removeItem("token"),U("/login");return}if(!l.ok){const i=await l.text();throw new Error(i||`HTTP ${l.status}`)}const u=await l.json(),s=u&&u.data?u.data:[],n={};for(const i of s){const k=i.fecha_hora?new Date(i.fecha_hora):i.createdAt?new Date(i.createdAt):null;if(!k)continue;const X=k.getFullYear()+"-"+String(k.getMonth()+1).padStart(2,"0")+"-"+String(k.getDate()).padStart(2,"0"),Q=Number(i.precio_cobrado)||0,W=Number(i.cantidad)||0,G=Number(i.cambioUSD_al_vender)||1,me=G&&G!==0?Q*W/G:Q*W;n[X]=(n[X]||0)+me}const r=[],p=new Date(F.value+"T00:00:00"),w=new Date(M.value+"T00:00:00");for(let i=new Date(p);i<=w;i.setDate(i.getDate()+1)){const k=i.getFullYear()+"-"+String(i.getMonth()+1).padStart(2,"0")+"-"+String(i.getDate()).padStart(2,"0");r.push(k)}const S=r.map((i,k)=>({day:i,value:+(n[i]||0),idx:k}));h.value=S}catch(a){console.error("Informe B error:",a),N.value=a&&a.message?a.message:String(a)}finally{z.value=!1}})()}fe(()=>{j.value="A",K(),ie()});const I=xe(),H=c(!1),A=c(0),E=c(0),D=c(0),C=c(0),T=c(0),$=c(0),P=c(!1),y=c(0),b=c(!1),_=c(""),q=O(()=>Math.min(100,Math.round(y.value/L*100)));async function B(a,t){const o=await fetch(a,{method:"GET",headers:{Accept:"application/json",Authorization:t}});if(o.status===401)throw localStorage.removeItem("token"),U("/login"),new Error("Unauthorized");if(!o.ok){const d=await o.text();throw new Error(d||`HTTP ${o.status}`)}return o.json()}function g(a){if(a==null||a==="")return 0;const t=Number(a);return isNaN(t)?0:t}async function K(){H.value=!0,P.value=!0,y.value=0,b.value=!1,_.value="",A.value=E.value=D.value=C.value=T.value=$.value=0;try{const a=localStorage.getItem("token");if(!a){U("/login");return}let t=[];try{t=await B(`${I.public.backendHost}/entrada`,a)}catch(s){console.error(s),b.value=!0,_.value="Error consultando entradas"}y.value+=1;try{let s=0;for(const n of t||[]){const r=g(n.cantidadEntrada),p=g(n.costo_usd);s+=r*p}A.value=s}catch(s){console.error(s)}let o=[];try{o=await B(`${I.public.backendHost}/producto`,a)}catch(s){console.error(s),b.value=!0,_="Error consultando productos"}y.value+=1;try{let s=0;for(const n of o||[]){const r=g(n.costo_usd),p=g(n.cantidadExistencia);s+=r*p}E.value=s}catch(s){console.error(s)}let d=[];try{d=await B(`${I.public.backendHost}/venta`,a)}catch(s){console.error(s),b.value=!0,_="Error consultando ventas"}y.value+=1;try{let s=0,n=0;for(const r of d||[]){const p=g(r.precio_cobrado),w=g(r.costo_venta_usd),S=g(r.cantidad),i=g(r.cambioUSD_al_vender)||1;s+=p*S/i,n+=w*S}D.value=s,C.value=n}catch(s){console.error(s)}let l=[];try{l=await B(`${I.public.backendHost}/salida`,a)}catch(s){console.error(s),b.value=!0,_="Error consultando salidas"}y.value+=1;try{let s=0;for(const n of l||[]){const r=g(n.cantidad),p=g(n.costo_producto_usd);s+=r*p}T.value=s}catch(s){console.error(s)}let u=[];try{const s=await fetch(`${I.public.backendHost}/Retiro/filterRetiros/null/null`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:a},body:JSON.stringify({})});if(s.ok){const n=await s.json();u=n&&n.data?n.data:[]}else console.error("retiros fetch status",s.status),b.value=!0,_="Error consultando retiros"}catch(s){console.error(s),b.value=!0,_="Error consultando retiros"}y.value+=1;try{let s=0;for(const n of u||[]){const r=g(n.cantidad_retirada_cup),p=g(n.cantidad_retirada_usd),w=g(n.cambio_moneda)||1,S=w&&w!==0?r/w:r;s+=S+p}$.value=s}catch(s){console.error(s)}}catch(a){console.error("Error generating informe A:",a),b.value=!0,_.value="Ocurrió un error generando el informe"}finally{H.value=!1,P.value=!1,y.value=L}}const de=O(()=>{const a=[A.value,E.value,D.value,T.value],t=["#F97316","#0369A1","#10B981","#EF4444"],o=a.reduce((s,n)=>s+Math.max(0,n),0),d=.6;let l=0;const u=[];if(!o||o<=0)return"conic-gradient(#eef2f7 0% 100%)";for(let s=0;s<a.length;s++){const r=Math.max(0,a[s])/o*100,p=Math.max(0,r-d);if(p>0){const w=l,S=l+p;u.push(`${t[s]} ${w}% ${S}%`),l=S}l+=d,u.push(`transparent ${Math.max(0,l-d)}% ${l}%`)}return l<100&&u.push(`transparent ${l}% 100%`),`conic-gradient(${u.join(", ")})`}),R=O(()=>{const a=[A.value,E.value,D.value,T.value,$.value,C.value],t=a.reduce((o,d)=>o+Math.max(0,d),0)||0;return t===0?a.map(()=>0):a.map(o=>Math.max(0,o)/t*100)}),ue=O(()=>(D.value||0)-(C.value||0)-(T.value||0)-($.value||0));return(a,t)=>(x(),m("div",ye,[Z(be,{title:"Informes - Pactum",description:"Panel de Informes en Pactum",canonical:"/informes"}),Z(he),e("div",_e,[e("div",we,[t[5]||(t[5]=e("h2",{class:"text-2xl font-bold mb-4"},"Informes",-1)),e("div",Se,[e("div",ke,[e("button",{onClick:t[0]||(t[0]=o=>re("A")),class:pe(["px-6 py-3 rounded-lg transition relative",j.value==="A"?"bg-primary text-neutral hover:bg-primary/90":"bg-white text-gray-700 border"])}," Resumen General de Inventario y Ventas ",2),e("button",{onClick:le,class:"absolute -top-2 -right-2 w-5 h-5 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs shadow","aria-label":"info informe A"},"!"),V.value?(x(),m("div",Ie," Muestra gráficamente el resumen de costos de compra, valor del inventario y ventas en USD y resumiendolo todo en la ganancia hasta el momento. ")):Y("",!0)])])]),e("div",De,[t[19]||(t[19]=e("h3",{class:"text-xl font-semibold mb-2"},"Vista de Informe",-1)),e("div",Te,[j.value==="A"?(x(),m("div",je,[e("div",Fe,[H.value?(x(),m("div",Me,"Cargando informe...")):(x(),m("div",Ae,[e("div",{class:"absolute inset-0 rounded-full",style:ee({background:de.value,borderRadius:"9999px",boxShadow:"0 6px 12px rgba(0,0,0,0.08)"})},null,4)]))]),P.value||b.value?(x(),m("div",Ee,[e("div",Ce,[P.value?(x(),m("div",$e,[t[6]||(t[6]=e("h3",{class:"text-lg font-semibold mb-2"},"Consultando datos del informe...",-1)),e("div",Ve,[e("div",{style:ee({width:q.value+"%"}),class:"h-3 bg-primary transition-all"},null,4)]),e("div",Ne,"Progreso: "+v(y.value)+" / "+v(L)+" — "+v(q.value)+"%",1)])):b.value?(x(),m("div",Pe,[t[7]||(t[7]=e("h3",{class:"text-lg font-semibold mb-2 text-red-600"},"Ocurrió un error",-1)),e("p",Be,v(_.value||"ocurrió un error al consultar o calcular datos"),1),e("div",Re,[e("button",{onClick:t[1]||(t[1]=()=>a.window.location.reload()),class:"px-4 py-2 bg-primary text-white rounded"},"Refrescar página"),e("button",{onClick:t[2]||(t[2]=()=>ge(U)("/")),class:"px-4 py-2 bg-gray-200 rounded"},"Volver al inicio")])])):Y("",!0)])])):Y("",!0),e("div",Oe,[e("div",Ue,[e("div",ze,[t[8]||(t[8]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-orange-400 inline-block"}),e("span",{class:"font-medium"},"Costos de compra")]),e("div",{class:"text-xs text-gray-500"},[f("Sumatoria de ("),e("em",null,"cantidad-de-entradas * costo-de-entrada-usd"),f(") de todo el inventario.")])],-1)),e("div",He,[f(v(A.value.toFixed(2))+" ",1),e("span",Ge,"("+v(R.value[0].toFixed(1))+"%)",1)])]),e("div",Ye,[t[9]||(t[9]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-blue-500 inline-block"}),e("span",{class:"font-medium"},"Inventario (valor)")]),e("div",{class:"text-xs text-gray-500"},[f("Sumatoria de ("),e("em",null,"costo-usd * cantidad-en-existencia"),f(") de todos los productos en el sistema.")])],-1)),e("div",Le,[f(v(E.value.toFixed(2))+" ",1),e("span",Je,"("+v(R.value[1].toFixed(1))+"%)",1)])]),e("div",qe,[t[10]||(t[10]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-green-500 inline-block"}),e("span",{class:"font-medium"},"Ventas (USD)")]),e("div",{class:"text-xs text-gray-500"},[f("Sumatoria de ("),e("em",null,"precio-usd-cobrado-de-venta * cantidad"),f(") de todas las ventas.")])],-1)),e("div",Ke,[f(v(D.value.toFixed(2))+" ",1),e("span",Xe,"("+v(R.value[2].toFixed(1))+"%)",1)])]),e("div",Qe,[t[11]||(t[11]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-red-500 inline-block"}),e("span",{class:"font-medium"},"Salidas (Pérdidas)")]),e("div",{class:"text-xs text-gray-500"},[f("Sumatoria de ("),e("em",null,"cantidad * producto.costo_usd"),f(") de las salidas (pérdidas).")])],-1)),e("div",We,[f(v(T.value.toFixed(2))+" ",1),e("span",Ze,"("+v(R.value[3].toFixed(1))+"%)",1)])]),e("div",et,[t[12]||(t[12]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-white border border-gray-300 inline-block"}),e("span",{class:"font-medium"},"Retiros (USD)")]),e("div",{class:"text-xs text-gray-500"},[f("Sumatoria convertida en USD: ("),e("em",null,"cantidad_retirada_cup / cambio_moneda"),f(") + "),e("em",null,"cantidad_retirada_usd"),f(".")])],-1)),e("div",tt,v($.value.toFixed(2)),1)]),e("div",st,[t[13]||(t[13]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm border border-gray-300 inline-block"}),e("span",{class:"font-medium"},"Costo Ventas (USD)")]),e("div",{class:"text-xs text-gray-500"},[f("Sumatoria de ("),e("em",null,"costo-venta * cantidad"),f(") de todas las ventas registradas.")])],-1)),e("div",at,v(C.value.toFixed(2)),1)]),e("div",ot,[t[14]||(t[14]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm border border-gray-300 inline-block"}),e("span",{class:"font-medium"},"Ganancia (Ventas - Costos - Retiros)")]),e("div",{class:"text-xs text-gray-500"},[f("Ganancia neta: "),e("em",null,"Ventas - Costo de ventas - Pérdidas - Retiros")])],-1)),e("div",nt,v(ue.value.toFixed(2)),1)])])])])):(x(),m("div",lt,[t[17]||(t[17]=e("h4",{class:"text-lg font-medium"},"Informe B — Rango de fechas",-1)),e("div",rt,[e("label",it,[t[15]||(t[15]=e("div",{class:"text-sm text-gray-600 mb-1"},"Fecha inicio",-1)),te(e("input",{type:"date","onUpdate:modelValue":t[3]||(t[3]=o=>F.value=o),class:"w-full px-3 py-2 border rounded"},null,512),[[se,F.value]])]),e("label",ct,[t[16]||(t[16]=e("div",{class:"text-sm text-gray-600 mb-1"},"Fecha fin",-1)),te(e("input",{type:"date","onUpdate:modelValue":t[4]||(t[4]=o=>M.value=o),class:"w-full px-3 py-2 border rounded"},null,512),[[se,M.value]])]),e("div",{class:"flex items-end"},[e("button",{onClick:ce,class:"px-4 py-2 bg-primary text-neutral rounded"},"Generar")])]),t[18]||(t[18]=e("div",{class:"text-xs text-gray-500"},"Valores iniciales: mes anterior (inicio=1, fin=último día).",-1)),e("div",dt,[z.value?(x(),m("div",ut,"Generando informe...")):N.value?(x(),m("div",mt,"Error: "+v(N.value),1)):h.value.length===0?(x(),m("div",vt,"No hay ventas en el rango seleccionado.")):(x(),m("div",ft,[(x(),m("svg",xt,[e("polyline",{points:h.value.map((o,d)=>{const l=d/(h.value.length-1||1)*100,u=Math.min(...h.value.map(r=>r.value)),s=Math.max(...h.value.map(r=>r.value)),n=s===u?25:10+(1-(o.value-u)/(s-u))*30;return l+","+n}).join(" "),fill:"none",stroke:"#2563eb","stroke-width":"0.8","stroke-linejoin":"round","stroke-linecap":"round"},null,8,pt),e("g",null,[(x(!0),m(ae,null,oe(h.value,(o,d)=>(x(),m("circle",{key:o.day,cx:d/(h.value.length-1||1)*100,cy:(function(){const l=Math.min(...h.value.map(s=>s.value)),u=Math.max(...h.value.map(s=>s.value));return u===l?25:10+(1-(o.value-l)/(u-l))*30})(),r:"1.2",fill:"#2563eb"},null,8,gt))),128))])])),e("div",ht,[(x(!0),m(ae,null,oe(h.value,o=>(x(),m("div",{key:o.day,class:"px-2 py-1 bg-gray-50 rounded border text-xs"},v(o.day)+": "+v(o.value.toFixed(2)),1))),128))])]))])]))])])])]))}},It=ve(bt,[["__scopeId","data-v-48132de0"]]);export{It as default};
