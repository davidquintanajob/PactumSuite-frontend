import{U as Ae,r as n,k as C,M as ye,V as Ie,I as Oe,z as y,D as ne,A as e,y as b,F as D,B as c,H as ze,C as I,E as M,K as O,L as z,O as He,P as Be,o as Le,q as P,R as le,X as Je,Y as Ge,n as Ke,h as se}from"#entry";import{N as qe}from"./DTHag2Fn.js";import{S as Ye}from"./CC2Sf2Ne.js";import{D as We}from"./DIpJa8iN.js";import{_ as be}from"./CP6NTKUH.js";import{_ as Xe}from"./DWLPyndB.js";import{_ as Qe}from"./D9EgduSG.js";import{u as de,w as Ze}from"./3SA47z_C.js";import"./BzLCLO6P.js";const et={class:"text-lg font-semibold text-gray-900"},tt={key:0,class:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50"},at={key:1,class:"mb-4"},ot={key:2,class:"space-y-6"},rt={class:"bg-blue-50 rounded-lg p-4"},st={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},it={class:"mt-1 text-sm text-gray-900"},nt={class:"mt-1 text-sm text-gray-900"},lt={class:"mt-1 text-sm text-gray-900"},dt={class:"mt-1 text-sm text-gray-900"},ut={class:"md:col-span-2"},ct={class:"mt-1 text-sm text-gray-900"},mt={class:"md:col-span-2"},vt={class:"mt-1 text-sm text-gray-900"},pt={class:"bg-gray-50 rounded-lg p-4"},gt={class:"text-sm"},ft={class:"text-sm"},yt={class:"text-sm"},bt={class:"bg-gray-50 rounded-lg p-4"},xt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ht={class:"mt-1 text-sm text-gray-900"},wt={class:"mt-1 text-sm text-gray-900"},_t={key:3,class:"space-y-6"},kt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},St={class:"md:col-span-2"},Ct={class:"md:col-span-2 bg-gray-50 rounded-lg p-4"},$t={class:"text-sm"},Ut={class:"text-sm"},Dt={class:"text-sm"},Nt={key:0,class:"bg-red-50 border border-red-200 text-red-700 p-3 rounded"},Rt={class:"flex justify-end gap-2"},Et=["disabled"],Tt=["disabled"],Vt={__name:"RetiroModal",props:{modelValue:{type:Boolean,default:!1},retiro:{type:Object,default:()=>({})},isViewing:{type:Boolean,default:!0},isEditing:{type:Boolean,default:!1},submitHandler:{type:Function,default:null}},emits:["update:modelValue","submit","success"],setup(l,{emit:F}){const p=l,w=F,r=Ae({cantidad_retirada_cup:null,cantidad_retirada_usd:null,cambio_moneda:null,motivo:"",fecha:"",id_usuario:null}),u=n(null),g=n([]),x=n(!1),_=n(null),H=n(null),q=n(!1),ie=C(()=>!u.value||!r.cantidad_retirada_cup?"":((Number(r.cantidad_retirada_cup)||0)/u.value).toFixed(5)),B=C(()=>!u.value||!r.cantidad_retirada_usd?"":((Number(r.cantidad_retirada_usd)||0)*u.value).toFixed(5)),Y=C(()=>u.value!=null?Number(u.value).toFixed(5):"-");function j(){try{const i=localStorage.getItem("config");if(i){const a=JSON.parse(i);a&&a.cambio_moneda?u.value=Number(a.cambio_moneda)||1:u.value=1}else u.value=1}catch{u.value=1}q.value=!0}ye(()=>p.modelValue,async i=>{if(i){if(!q.value)j();else try{const a=localStorage.getItem("config");if(a){const m=JSON.parse(a);m&&m.cambio_moneda&&(u.value=Number(m.cambio_moneda)||1)}}catch{}if(await Ie(),!p.isEditing&&!p.isViewing){r.cantidad_retirada_cup=0,r.cantidad_retirada_usd=0,r.motivo="";const a=new Date,m=a.getFullYear(),N=String(a.getMonth()+1).padStart(2,"0"),A=String(a.getDate()).padStart(2,"0");r.fecha=`${m}-${N}-${A}`,r.cambio_moneda=u.value!=null?u.value:1,g.value=[],_.value=null;{const R=localStorage.getItem("usuario");if(R)try{const $=JSON.parse(R);r.id_usuario=$.id_usuario||$.id||null}catch{r.id_usuario=null}}}else u.value=p.retiro?.cambio_moneda||u.value||1,r.cambio_moneda=p.retiro?.cambio_moneda||null,g.value=[],_.value=null}else g.value=[],_.value=null},{immediate:!1,flush:"post"}),ye(()=>p.retiro,i=>{if(i&&Object.keys(i).length)r.cantidad_retirada_cup=i.cantidad_retirada_cup||0,r.cantidad_retirada_usd=i.cantidad_retirada_usd||0,r.cambio_moneda=i.cambio_moneda||null,u.value=i.cambio_moneda||u.value||1,r.motivo=i.motivo||"",r.fecha=i.fecha?i.fecha.substring(0,10):"",r.id_usuario=i.id_usuario||null;else{r.cantidad_retirada_cup=0,r.cantidad_retirada_usd=0,r.cambio_moneda=null,u.value=null,r.motivo="";const a=new Date,m=a.getFullYear(),N=String(a.getMonth()+1).padStart(2,"0"),A=String(a.getDate()).padStart(2,"0");r.fecha=`${m}-${N}-${A}`;{const R=localStorage.getItem("usuario");if(R)try{const $=JSON.parse(R);r.id_usuario=$.id_usuario||$.id||null}catch{r.id_usuario=null}}}},{immediate:!0,deep:!0});function W(){x.value||w("update:modelValue",!1)}async function L(){if(console.log("onSubmit called, submitHandler:",p.submitHandler),g.value=[],!r.id_usuario||r.id_usuario===null)try{const a=localStorage.getItem("usuario");if(a){const m=JSON.parse(a);r.id_usuario=m.id_usuario||m.id||null}}catch{}if(r.cantidad_retirada_cup==null&&r.cantidad_retirada_usd==null&&g.value.push("Debe ingresar al menos un monto en CUP o USD"),r.motivo||g.value.push("Debe indicar un motivo"),r.fecha||g.value.push("Debe seleccionar una fecha"),r.id_usuario||g.value.push("Usuario inválido"),g.value.length){console.log("form validation failed",g.value);return}const i={cantidad_retirada_cup:r.cantidad_retirada_cup!=null?Number(r.cantidad_retirada_cup):null,cantidad_retirada_usd:r.cantidad_retirada_usd!=null?Number(r.cantidad_retirada_usd):null,cambio_moneda:u.value!=null?Number(u.value):null,motivo:r.motivo,fecha:r.fecha,id_usuario:r.id_usuario};if(console.log("onSubmit payload",i),p.submitHandler&&typeof p.submitHandler=="function"){try{x.value=!0;const a=await p.submitHandler(i);w("success",{title:p.isEditing?"Retiro actualizado":"Retiro creado",description:""}),w("update:modelValue",!1)}catch(a){g.value.push(a.message||"Error al guardar")}finally{x.value=!1}return}w("submit",i)}return(i,a)=>(y(),Oe(Qe,{show:l.modelValue,onClose:W,size:"2xl"},{title:ne(()=>[e("h3",et,c(l.isViewing?"Detalles del Retiro":l.isEditing?"Editar Retiro":"Nuevo Retiro"),1)]),content:ne(()=>[e("div",{ref_key:"contentWrapper",ref:H,class:ze(["transition-opacity",x.value&&"pointer-events-none opacity-50"])},[x.value?(y(),b("div",tt,[...a[5]||(a[5]=[e("div",{class:"bg-white rounded-lg p-8 shadow-xl flex flex-col items-center gap-4"},[e("div",{class:"w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin"}),e("p",{class:"text-gray-700 font-medium"},"Procesando, espere...")],-1)])])):D("",!0),_.value?(y(),b("div",at,[I(be,{title:_.value.title,description:_.value.description,type:_.value.type,onClose:a[0]||(a[0]=m=>_.value=null)},null,8,["title","description","type"])])):D("",!0),l.isViewing?(y(),b("div",ot,[e("div",rt,[a[12]||(a[12]=e("h4",{class:"text-md font-medium text-gray-900 mb-3"},"Información del Retiro",-1)),e("div",st,[e("div",null,[a[6]||(a[6]=e("label",{class:"block text-sm font-medium text-gray-700"},"Usuario",-1)),e("p",it,c(l.retiro.usuario?.nombre||"N/A"),1)]),e("div",null,[a[7]||(a[7]=e("label",{class:"block text-sm font-medium text-gray-700"},"Cantidad CUP",-1)),e("p",nt,c(Number(l.retiro.cantidad_retirada_cup||0).toFixed(2)),1)]),e("div",null,[a[8]||(a[8]=e("label",{class:"block text-sm font-medium text-gray-700"},"Cantidad USD",-1)),e("p",lt,c(Number(l.retiro.cantidad_retirada_usd||0).toFixed(2)),1)]),e("div",null,[a[9]||(a[9]=e("label",{class:"block text-sm font-medium text-gray-700"},"Cambio moneda",-1)),e("p",dt,c(Number(l.retiro.cambio_moneda||0).toFixed(2)),1)]),e("div",ut,[a[10]||(a[10]=e("label",{class:"block text-sm font-medium text-gray-700"},"Motivo",-1)),e("p",ct,c(l.retiro.motivo||"Sin motivo"),1)]),e("div",mt,[a[11]||(a[11]=e("label",{class:"block text-sm font-medium text-gray-700"},"Fecha",-1)),e("p",vt,c(l.retiro.fecha?new Date(l.retiro.fecha).toLocaleDateString("es-ES"):"N/A"),1)])])]),e("div",pt,[a[16]||(a[16]=e("h4",{class:"text-md font-medium text-gray-900 mb-2"},"Conversión de montos",-1)),e("p",gt,[a[13]||(a[13]=M("Tasa utilizada: ",-1)),e("strong",null,c(l.retiro.cambio_moneda?Number(l.retiro.cambio_moneda).toFixed(2):"-"),1)]),e("p",ft,[a[14]||(a[14]=M("CUP → USD: ",-1)),e("strong",null,c(l.retiro.cantidad_retirada_cup&&l.retiro.cambio_moneda?(Number(l.retiro.cantidad_retirada_cup)/Number(l.retiro.cambio_moneda)).toFixed(5):""),1)]),e("p",yt,[a[15]||(a[15]=M("USD → CUP: ",-1)),e("strong",null,c(l.retiro.cantidad_retirada_usd&&l.retiro.cambio_moneda?(Number(l.retiro.cantidad_retirada_usd)*Number(l.retiro.cambio_moneda)).toFixed(5):""),1)])]),e("div",bt,[a[19]||(a[19]=e("h4",{class:"text-md font-medium text-gray-900 mb-3"},"Información del Sistema",-1)),e("div",xt,[e("div",null,[a[17]||(a[17]=e("label",{class:"block text-sm font-medium text-gray-700"},"Creado",-1)),e("p",ht,c(l.retiro.createdAt?new Date(l.retiro.createdAt).toLocaleString("es-ES"):"N/A"),1)]),e("div",null,[a[18]||(a[18]=e("label",{class:"block text-sm font-medium text-gray-700"},"Última Actualización",-1)),e("p",wt,c(l.retiro.updatedAt?new Date(l.retiro.updatedAt).toLocaleString("es-ES"):"N/A"),1)])])])])):(y(),b("div",_t,[e("div",kt,[e("div",null,[a[20]||(a[20]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Cantidad CUP",-1)),O(e("input",{type:"number","onUpdate:modelValue":a[1]||(a[1]=m=>r.cantidad_retirada_cup=m),step:"any",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Cantidad en CUP..."},null,512),[[z,r.cantidad_retirada_cup,void 0,{number:!0}]])]),e("div",null,[a[21]||(a[21]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Cantidad USD",-1)),O(e("input",{type:"number","onUpdate:modelValue":a[2]||(a[2]=m=>r.cantidad_retirada_usd=m),step:"any",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Cantidad en USD..."},null,512),[[z,r.cantidad_retirada_usd,void 0,{number:!0}]])]),e("div",null,[a[22]||(a[22]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha",-1)),O(e("input",{type:"date","onUpdate:modelValue":a[3]||(a[3]=m=>r.fecha=m),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary"},null,512),[[z,r.fecha]])]),e("div",St,[a[23]||(a[23]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Motivo",-1)),O(e("input",{type:"text","onUpdate:modelValue":a[4]||(a[4]=m=>r.motivo=m),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Motivo..."},null,512),[[z,r.motivo]])]),e("div",Ct,[a[27]||(a[27]=e("h4",{class:"text-md font-medium text-gray-900 mb-2"},"Cambio de moneda",-1)),e("p",$t,[a[24]||(a[24]=M("Tasa utilizada: ",-1)),e("strong",null,c(Y.value),1)]),e("p",Ut,[a[25]||(a[25]=M("CUP → USD: ",-1)),e("strong",null,c(ie.value),1)]),e("p",Dt,[a[26]||(a[26]=M("USD → CUP: ",-1)),e("strong",null,c(B.value),1)])])]),g.value.length?(y(),b("div",Nt,[(y(!0),b(He,null,Be(g.value,(m,N)=>(y(),b("div",{key:N},c(m),1))),128))])):D("",!0)]))],2)]),footer:ne(()=>[e("div",Rt,[l.isViewing?D("",!0):(y(),b("button",{key:0,onClick:L,disabled:x.value,class:"px-4 py-2 bg-primary text-neutral rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-all"},c(x.value?l.isEditing?"Guardando...":"Creando...":l.isEditing?"Guardar":"Crear"),9,Et)),e("button",{onClick:W,disabled:x.value,class:"px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"}," Cerrar ",8,Tt)])]),_:1},8,["show"]))}},Pt={class:"min-h-screen bg-gradient-to-br via-secondary/40 from-accent/30 to-neutral"},Ft={key:0,class:"fixed top-6 left-1/2 transform -translate-x-1/2 z-[9999] w-full max-w-md px-4 pointer-events-none"},Mt={key:1,class:"fixed top-24 left-1/2 transform -translate-x-1/2 z-[10000] w-full max-w-md px-4 pointer-events-auto"},jt={class:"w-[95%] mx-auto px-4 py-4 md:py-4 mt-20 md:mt-0"},At={class:"bg-white rounded-lg shadow-md p-4"},It={class:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"},Ot={class:"w-full"},zt={class:"w-full"},Ht={class:"w-full"},Bt={class:"w-[95%] mx-auto px-4 py-4"},Lt={class:"bg-white rounded-lg shadow-md p-4"},Jt={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},Gt={class:"p-4 bg-gray-50 rounded"},Kt={class:"text-lg font-semibold"},qt={class:"p-4 bg-gray-50 rounded"},Yt={class:"text-lg font-semibold"},Wt={class:"p-4 bg-gray-50 rounded"},Xt={class:"text-lg font-semibold"},Qt={class:"p-4 bg-gray-50 rounded"},Zt={class:"text-lg font-semibold"},ea={class:"grid grid-cols-2 gap-4 mt-4"},ta={class:"p-4 bg-gray-50 rounded"},aa={class:"text-lg font-semibold"},oa={class:"p-4 bg-gray-50 rounded"},ra={class:"text-lg font-semibold"},sa={key:0,class:"fixed inset-0 z-[20000] flex items-center justify-center bg-black/60"},ia={class:"bg-white rounded-lg p-6 w-full max-w-lg mx-4"},na={key:0},la={class:"w-full bg-gray-100 rounded h-3 overflow-hidden mb-3"},da={class:"text-sm text-gray-600"},ua={key:1},ca={class:"text-sm text-gray-700 mb-4"},ma={class:"flex gap-2 justify-end"},va={class:"flex justify-end mt-4 gap-2 flex-wrap"},pa={class:"w-[95%] mx-auto px-4 py-4"},ga={class:"flex justify-between items-center mb-4"},ue=5,Ca={__name:"retiros",setup(l){const F=n(""),p=n(""),w=n(""),r=n(!1),u=n({}),g=n(!1),x=n(!1),_=n(!1),H=n(null),q=[{key:"usuario.nombre",label:"Usuario"},{key:"cantidad_retirada_cup",label:"CUP",cellRenderer:o=>{if(o==null||o==="")return"";const t=parseFloat(o);return isNaN(t)?o:`<span class="px-2 py-1 rounded text-sm">${t.toFixed(2)}</span>`}},{key:"cantidad_retirada_usd",label:"USD",cellRenderer:o=>{if(o==null||o==="")return"";const t=parseFloat(o);return isNaN(t)?o:`<span class="px-2 py-1 rounded text-sm">${t.toFixed(2)}</span>`}},{key:"motivo",label:"Motivo"},{key:"fecha",label:"Fecha",cellRenderer:o=>o?`<span class="px-2 py-1 rounded text-sm">${o.substring(0,10)}</span>`:""}],ie=C(()=>q),B=n(1),Y=n(0),j=n(!1),W=n(20),L=n([]),i=n(null),a=Ke(),m=C(()=>{try{const o=localStorage.getItem("usuario");if(!o)return!1;const t=JSON.parse(o),s=t&&(t.rol||t.role||t.perfil&&t.perfil.rol||t.profile&&t.profile.role)?t.rol||t.role||t.perfil&&t.perfil.rol||t.profile&&t.profile.role:null;return s?String(s).trim().toLowerCase()==="invitado":!1}catch{return!1}}),N=n(0),A=n(0),R=n(0),$=n(0),ce=n(0),xe=n(0),he=n(0),X=n(!1),E=n(0),U=n(!1),T=n(""),we=C(()=>(N.value||0)-(R.value||0)-(A.value||0)),_e=C(()=>($.value||0)-Se.value),ke=C(()=>(ce.value||0)-Ce.value),Se=C(()=>(L.value||[]).reduce((o,t)=>o+S(t.cantidad_retirada_cup),0)),Ce=C(()=>(L.value||[]).reduce((o,t)=>o+S(t.cantidad_retirada_usd),0)),me=C(()=>Math.min(100,Math.round(E.value/ue*100)));function S(o){if(o==null||o==="")return 0;const t=Number(o);return isNaN(t)?0:t}async function Q(o,t){const s=await fetch(o,{method:"GET",headers:{Accept:"application/json",Authorization:t}});if(s.status===401)throw localStorage.removeItem("token"),P("/"),new Error("Unauthorized");if(!s.ok){const f=await s.text().catch(()=>null);throw new Error(f||`HTTP ${s.status}`)}return s.json()}async function $e(){X.value=!0,E.value=0,U.value=!1,T.value="";const o=localStorage.getItem("token");if(!o){P("/");return}try{let t=[];try{t=await Q(`${a.public.backendHost}/entrada`,o)}catch{U.value=!0,T.value="ocurrió un error al consultar o calcular datos"}E.value+=1;let s=[];try{s=await Q(`${a.public.backendHost}/producto`,o)}catch{U.value=!0,T.value="ocurrió un error al consultar o calcular datos"}E.value+=1;let f=[];try{f=await Q(`${a.public.backendHost}/venta`,o)}catch{U.value=!0,T.value="ocurrió un error al consultar o calcular datos"}E.value+=1;let h=[];try{h=await Q(`${a.public.backendHost}/salida`,o)}catch{U.value=!0,T.value="ocurrió un error al consultar o calcular datos"}E.value+=1;let v=[];try{const d=await fetch(`${a.public.backendHost}/Retiro/filterRetiros/1/99999`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:o},body:JSON.stringify({})});if(d.ok){const V=await d.json();v=V&&V.data?V.data:[]}}catch{}E.value+=1;let k=0,K=0;try{for(const d of v||[])k+=S(d.cantidad_retirada_cup),K+=S(d.cantidad_retirada_usd);xe.value=k,he.value=K}catch{k=0,K=0}try{let d=0,V=0,ee=0,te=0;for(const J of f||[]){const ae=S(J.precio_cobrado),ge=S(J.costo_venta_usd),oe=S(J.cantidad),re=S(J.cambioUSD_al_vender)||1;d+=ae*oe/re,V+=ge*oe;const fe=(J.forma_pago||"").trim(),Me=S(J.costo_venta);if(["Efectivo CUP","Transferencia CUP","Efectivo y Transferencia"].includes(fe)&&(ee+=(ae-Me)*oe),["Efectivo USD","Transferencia USD"].includes(fe)){const je=re&&re!==0?ae/re:ae;te+=(je-ge)*oe}}N.value=d,R.value=V,$.value=ee,ce.value=te}catch{U.value=!0,T.value="ocurrió un error al consultar o calcular datos"}try{let d=0;for(const V of h||[]){const ee=S(V.cantidad),te=S(V.costo_producto_usd);d+=ee*te}A.value=d}catch{U.value=!0,T.value="ocurrió un error al consultar o calcular datos"}}catch{U.value=!0,T.value="ocurrió un error al consultar o calcular datos"}finally{E.value=ue,X.value=!1}}const ve={render(){return se("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[se("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})])}},Ue=[{name:"Editar",icon:{render(){return se("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[se("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})])}},handler:o=>pe(o,"editar"),iconOnly:!1,buttonClass:"px-3 py-1 bg-accent text-neutral rounded-md hover:bg-accent/90"},{name:"Eliminar",icon:ve,handler:o=>Re(o),iconOnly:!1,buttonClass:"px-3 py-1 bg-danger text-neutral rounded-md hover:bg-danger/90"}];async function G(o=1){const t=localStorage.getItem("token");if(!t){P("/");return}try{j.value=!0;const s={};F.value&&(s.motivo=F.value),(p.value||w.value)&&(s.fecha={},p.value&&(s.fecha.inicio=p.value),w.value&&(s.fecha.fin=w.value));const f=await fetch(`${a.public.backendHost}/Retiro/filterRetiros/null/null`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t},body:JSON.stringify(s)});if(f.status===401){i.value={title:"Sesión Expirada",description:"Tu sesión ha expirado.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>P("/"),3e3);return}if(f.status===403){i.value={title:"Acceso Denegado",description:"No tienes permisos.",type:"error"};return}const h=await f.json();L.value=h.data||[],Y.value=h.pagination?.total||0,B.value=h.pagination?.currentPage||1}catch{i.value={title:"Error",description:"No se pudieron cargar los retiros",type:"error"}}finally{j.value=!1}}function pe(o,t){u.value={...o},g.value=t==="ver",x.value=t==="editar",r.value=!0}function De(o){pe(o,"ver")}function Ne(){u.value=null,g.value=!1,x.value=!1,r.value=!0}function Re(o){H.value=o,_.value=!0}async function Ee(){if(H.value)try{const o=localStorage.getItem("token"),t=await fetch(`${a.public.backendHost}/Retiro/deleteRetiro/${H.value.id_retiro}`,{method:"DELETE",headers:{Authorization:o,Accept:"application/json"}});if(t.status===401){i.value={title:"Sesión Expirada",description:"Tu sesión ha expirado.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>P("/"),3e3);return}let s=null;try{s=await t.json()}catch{}if(!t.ok){let f="Error desconocido";s&&s.errors&&Array.isArray(s.errors)?f=s.errors.join(`
• `):s&&typeof s.error=="string"?f=s.error:s&&(s.message||s.description)?f=s.message||s.description:s&&(f=JSON.stringify(s)),i.value={title:`Error ${t.status}`,description:f,type:"error"};return}i.value={title:"Retiro eliminado",description:"Se eliminó correctamente",type:"success"},await G(B.value)}catch{i.value={title:"Error",description:"Ocurrió un error al eliminar",type:"error"}}finally{_.value=!1,H.value=null}}async function Te(o){try{const t=localStorage.getItem("token"),s=x.value&&u.value?.id_retiro?`${a.public.backendHost}/Retiro/updateRetiro/${u.value.id_retiro}`:`${a.public.backendHost}/Retiro/createRetiro`,f=x.value?"PUT":"POST",h=await fetch(s,{method:f,headers:{"Content-Type":"application/json",Authorization:t,Accept:"application/json"},body:JSON.stringify(o)});if(h.status===401)throw i.value={title:"Sesión Expirada",description:"Tu sesión ha expirado.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>P("/"),3e3),new Error("Sesión expirada");if(h.status===403)throw i.value={title:"Acceso Denegado",description:"No tienes permisos.",type:"error"},new Error("Acceso denegado");let v=null;try{v=await h.json()}catch{}if(!h.ok){let k="Error desconocido";throw v&&v.errors&&Array.isArray(v.errors)?k=v.errors.join(`
• `):v&&typeof v.error=="string"?k=v.error:v&&(v.message||v.description)?k=v.message||v.description:v&&(k=JSON.stringify(v)),i.value={title:`Error ${h.status}`,description:k,type:"error"},new Error(k)}return v&&v.data?v.data:v}catch(t){throw console.error("Error en createOrUpdateRetiro:",t),t}}async function Ve(o){i.value={title:o?.title||"Retiro guardado",description:o?.description||"",type:"success"},r.value=!1,u.value={},x.value=!1,g.value=!1,await G(B.value)}const Z=async()=>{try{j.value=!0,await G(1)}finally{j.value=!1}};function Pe(o){G(o)}async function Fe(){i.value={title:"Consultando datos",description:"Se están consultando los datos, la descarga comenzará en breve.",type:"info"};try{const o=localStorage.getItem("token"),t={};F.value&&(t.motivo=F.value),(p.value||w.value)&&(t.fecha={},p.value&&(t.fecha.inicio=p.value),w.value&&(t.fecha.fin=w.value));const s=await fetch(`${a.public.backendHost}/Retiro/filterRetiros/null/null`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:o,Accept:"application/json"},body:JSON.stringify(t)});if(s.status===401){i.value={title:"Sesión Expirada",description:"Tu sesión ha expirado.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>P("/"),3e3);return}if(s.status===403){i.value={title:"Acceso Denegado",description:"No tienes permisos.",type:"error"};return}if(!s.ok){const d=await s.json();i.value={title:"Error al consultar datos",description:d.error||"Ocurrió un error al consultar los datos.",type:"error"};return}const h=(await s.json()).data.map(d=>({Usuario:d.usuario?.nombre||"",CUP:Number(d.cantidad_retirada_cup||0).toFixed(2),USD:Number(d.cantidad_retirada_usd||0).toFixed(2),Motivo:d.motivo||"",Fecha:d.fecha?d.fecha.substring(0,10):""})),v=de.json_to_sheet(h),k=de.book_new();de.book_append_sheet(k,v,"Retiros");const K=new Date().toISOString().split("T")[0];Ze(k,`retiros_${K}.xlsx`),i.value=null}catch{i.value={title:"Error",description:"Ocurrió un error al exportar los datos.",type:"error"}}}return Le(async()=>{if(!localStorage.getItem("token")){P("/");return}await $e(),await G()}),(o,t)=>(y(),b("div",Pt,[I(Ye,{title:"Retiros - Pactum",description:"Lista y gestión de retiros de efectivo.",canonical:"/retiros"}),I(qe),i.value?(y(),b("div",Ft,[I(be,{title:i.value.title,description:i.value.description,type:i.value.type,onClose:t[0]||(t[0]=s=>i.value=null),class:"pointer-events-auto"},null,8,["title","description","type"])])):D("",!0),_.value?(y(),b("div",Mt,[I(Xe,{title:"¿Estás seguro que deseas eliminar este retiro?",description:"Esta acción no se puede deshacer.",icon:ve,type:"warning",onConfirm:Ee,onClose:t[1]||(t[1]=s=>_.value=!1)})])):D("",!0),e("div",jt,[e("div",At,[e("div",It,[e("div",Ot,[t[8]||(t[8]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Motivo",-1)),O(e("input",{type:"text","onUpdate:modelValue":t[2]||(t[2]=s=>F.value=s),placeholder:"Motivo...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:le(Z,["enter"])},null,544),[[z,F.value]])]),e("div",zt,[t[9]||(t[9]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha desde",-1)),O(e("input",{type:"date","onUpdate:modelValue":t[3]||(t[3]=s=>p.value=s),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:le(Z,["enter"])},null,544),[[z,p.value]])]),e("div",Ht,[t[10]||(t[10]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha hasta",-1)),O(e("input",{type:"date","onUpdate:modelValue":t[4]||(t[4]=s=>w.value=s),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:le(Z,["enter"])},null,544),[[z,w.value]])])]),e("div",Bt,[e("div",Lt,[t[23]||(t[23]=e("h2",{class:"text-xl font-bold mb-4"},"Resumen rápido",-1)),e("div",Jt,[e("div",Gt,[t[11]||(t[11]=e("div",{class:"text-sm text-gray-600"},"Ventas (USD)",-1)),e("div",Kt,c(N.value.toFixed(2)),1),t[12]||(t[12]=e("div",{class:"text-xs text-gray-500 mt-2"},"Sumatoria de (precio cobrado × cantidad) convertidos a USD por la tasa usada en la venta.",-1))]),e("div",qt,[t[13]||(t[13]=e("div",{class:"text-sm text-gray-600"},"Salidas (Pérdidas)",-1)),e("div",Yt,c(A.value.toFixed(2)),1),t[14]||(t[14]=e("div",{class:"text-xs text-gray-500 mt-2"},"Sumatoria de (cantidad × costo del producto en USD) por salidas/pérdidas.",-1))]),e("div",Wt,[t[15]||(t[15]=e("div",{class:"text-sm text-gray-600"},"Costo Ventas (USD)",-1)),e("div",Xt,c(R.value.toFixed(2)),1),t[16]||(t[16]=e("div",{class:"text-xs text-gray-500 mt-2"},"Sumatoria de (costo de venta en USD × cantidad) de todas las ventas.",-1))]),e("div",Qt,[t[17]||(t[17]=e("div",{class:"text-sm text-gray-600"},"Ganancia (Ventas - Costos)",-1)),e("div",Zt,c(we.value.toFixed(2)),1),t[18]||(t[18]=e("div",{class:"text-xs text-gray-500 mt-2"},"Ventas − Costo de ventas − Salidas (pérdidas).",-1))])]),e("div",ea,[e("div",ta,[t[19]||(t[19]=e("div",{class:"text-sm text-gray-600"},"Ganancia en CUP de Ventas Restante",-1)),e("div",aa,c(_e.value.toFixed(2)),1),t[20]||(t[20]=e("div",{class:"text-xs text-gray-500 mt-2"},[e("span",{class:"font-bold italic"}," ∑ (precio-cobrado-cup − costo-venta-cup) − ∑ (retiros-cup) ")],-1))]),e("div",oa,[t[21]||(t[21]=e("div",{class:"text-sm text-gray-600"},"Ganancia en USD de Ventas Restante",-1)),e("div",ra,c(ke.value.toFixed(2)),1),t[22]||(t[22]=e("div",{class:"text-xs text-gray-500 mt-2"},[e("span",{class:"font-bold italic"}," ∑ (precio-cobrado-usd − costo-venta-usd) − ∑ (retiros-usd) ")],-1))])])]),X.value||U.value?(y(),b("div",sa,[e("div",ia,[X.value?(y(),b("div",na,[t[24]||(t[24]=e("h3",{class:"text-lg font-semibold mb-2"},"Consultando datos...",-1)),e("div",la,[e("div",{style:Je({width:me.value+"%"}),class:"h-3 bg-primary transition-all"},null,4)]),e("div",da,"Progreso: "+c(E.value)+" / "+c(ue)+" — "+c(me.value)+"%",1)])):U.value?(y(),b("div",ua,[t[25]||(t[25]=e("h3",{class:"text-lg font-semibold mb-2 text-red-600"},"Ocurrió un error",-1)),e("p",ca,c(T.value||"ocurrió un error al consultar o calcular datos"),1),e("div",ma,[e("button",{onClick:t[5]||(t[5]=()=>o.window.location.reload()),class:"px-4 py-2 bg-primary text-white rounded"},"Refrescar página"),e("button",{onClick:t[6]||(t[6]=()=>("navigateTo"in o?o.navigateTo:Ge(P))("/")),class:"px-4 py-2 bg-gray-200 rounded"},"Volver al inicio")])])):D("",!0)])])):D("",!0)]),e("div",va,[e("button",{onClick:Z,class:"px-6 py-2 bg-primary text-neutral rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors"}," Buscar "),m.value?D("",!0):(y(),b("button",{key:0,onClick:Fe,class:"px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors flex items-center"},[...t[26]||(t[26]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 12h2v2H7v-2zM11 12h2v2h-2v-2zM15 12h2v2h-2v-2z"})],-1),M(" Exportar a Excel ",-1)])]))])])]),e("div",pa,[e("div",ga,[t[28]||(t[28]=e("h2",{class:"text-2xl font-bold"},"Retiros",-1)),m.value?D("",!0):(y(),b("button",{key:0,onClick:Ne,class:"px-4 py-2 bg-primary text-neutral rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary flex items-center"},[...t[27]||(t[27]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),M(" Nuevo Retiro ",-1)])]))]),I(We,{columns:ie.value,items:L.value,actions:m.value?[]:Ue,"total-items":Y.value,"items-per-page":W.value,"current-page":B.value,"is-loading":j.value,onPageChange:Pe,onRowClick:De},null,8,["columns","items","actions","total-items","items-per-page","current-page","is-loading"])]),I(Vt,{modelValue:r.value,"onUpdate:modelValue":t[7]||(t[7]=s=>r.value=s),retiro:u.value,"is-editing":x.value,"is-viewing":g.value,submitHandler:Te,onSuccess:Ve},null,8,["modelValue","retiro","is-editing","is-viewing"])]))}};export{Ca as default};
