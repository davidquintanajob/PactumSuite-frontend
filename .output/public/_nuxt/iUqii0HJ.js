import{U as vt,r as u,k as Z,M as it,V as wt,I as ht,z as y,D as ut,A as e,y as x,F as S,B as i,H as Et,C as P,K as V,L as D,O as Ct,P as Nt,n as mt,o as St,q as W,R as B,E as bt,h as nt}from"#entry";import{N as _t}from"./DTHag2Fn.js";import{S as $t}from"./CC2Sf2Ne.js";import{D as Ut}from"./DIpJa8iN.js";import{_ as yt}from"./CP6NTKUH.js";import{_ as Pt}from"./baAHEXJQ.js";import{_ as xt}from"./BYdYousv.js";import{_ as kt}from"./DWLPyndB.js";import{_ as At}from"./D9EgduSG.js";import{u as ct,w as Ft}from"./3SA47z_C.js";import"./BzLCLO6P.js";const Vt={class:"text-lg font-semibold text-gray-900"},Dt={key:0,class:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50"},It={key:1,class:"mb-4"},Tt={key:2,class:"mb-4"},jt={key:3,class:"space-y-6"},zt={class:"bg-gray-50 rounded-lg p-4"},Lt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ot={class:"mt-1 text-sm text-gray-900"},Ht={class:"mt-1 text-sm text-gray-900"},Mt={class:"mt-1 text-sm text-gray-900"},Bt={class:"mt-1 text-sm text-gray-900"},Rt={class:"mt-1 text-sm text-gray-900"},Kt={class:"mt-1 text-sm text-gray-900"},Qt={class:"mt-4"},qt={class:"mt-1 text-sm text-gray-900"},Jt={class:"bg-blue-50 rounded-lg p-4"},Gt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Wt={class:"mt-1 text-sm text-gray-900"},Xt={class:"mt-1 text-sm text-gray-900"},Yt={class:"mt-1 text-sm text-gray-900"},Zt={class:"mt-1 text-sm font-semibold text-gray-900"},te={class:"mt-1 text-sm text-gray-900"},ee={class:"mt-4"},oe={class:"mt-1 text-sm text-gray-900"},ae={key:0,class:"bg-green-50 rounded-lg p-4"},se={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ne={class:"mt-1 text-sm text-gray-900"},re={class:"mt-1 text-sm text-gray-900"},le={class:"mt-1 text-sm text-gray-900"},de={class:"mt-1 text-sm text-gray-900"},ie={class:"mt-4"},ue={class:"mt-1 text-sm text-gray-900"},ce={key:1,class:"bg-yellow-50 rounded-lg p-4"},me={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},pe={class:"mt-1 text-sm text-gray-900"},fe={class:"mt-1 text-sm text-gray-900"},ge={class:"mt-1 text-sm text-gray-900"},ve={class:"mt-1 text-sm text-gray-900"},be={class:"bg-gray-50 rounded-lg p-4"},ye={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},xe={class:"mt-1 text-sm text-gray-900"},ke={class:"mt-1 text-sm text-gray-900"},we={key:4,class:"space-y-6"},he={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Ee=["value"],Ce=["value"],Ne=["value"],Se={class:"md:col-span-2"},_e={key:0,class:"bg-gray-50 rounded-lg p-4"},$e={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},Ue={class:"text-sm font-semibold"},Pe={class:"text-sm font-semibold"},Ae={class:"text-sm font-semibold"},Fe={class:"text-sm font-semibold"},Ve={class:"text-sm font-semibold"},De={class:"text-sm font-semibold"},Ie={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"},Te={class:"text-sm font-semibold"},je={class:"text-sm font-semibold"},ze={key:1,class:"bg-red-50 border border-red-200 text-red-700 p-3 rounded"},Le={class:"flex justify-end gap-2"},Oe=["disabled"],He=["disabled"],Me={__name:"EntradaModal",props:{modelValue:{type:Boolean,default:!1},entrada:{type:Object,default:()=>({})},isViewing:{type:Boolean,default:!0},isEditing:{type:Boolean,default:!1},submitHandler:{type:Function,required:!1}},emits:["update:modelValue","submit","success"],setup(l,{emit:T}){const h=l,C=T,a=vt({id_producto:null,cantidadEntrada:null,nota:"",fecha:"",costo:null,costo_usd:null}),f=u(null),g=u([]),v=u(!1),_=u(!1),m=vt({id_producto:null,nombre_producto:"",currentCosto:0,currentCostoUsd:0,suggestedCosto:0,suggestedCostoUsd:0,existingQty:0,entryQty:0}),$=u(null),j=u(null),N=u(1);Z(()=>{try{const r=localStorage.getItem("usuario");if(!r)return!1;const t=JSON.parse(r),d=t&&(t.rol||t.role||t.perfil&&t.perfil.rol||t.profile&&t.profile.role)?t.rol||t.role||t.perfil&&t.perfil.rol||t.profile&&t.profile.role:null;return d?String(d).trim().toLowerCase()==="admin":!1}catch{return!1}});const R=Z(()=>{const r=Number(a.cantidadEntrada)||0,t=Number(a.costo)||0;return(r*t).toFixed(5)}),z=Z(()=>{const r=Number(a.cantidadEntrada)||0,t=Number(a.costo_usd)||0;return(r*t).toFixed(5)});it(()=>h.entrada,r=>{r&&Object.keys(r).length?(a.id_producto=r.id_producto||r.producto?.id_producto||null,a.cantidadEntrada=r.cantidadEntrada||null,a.nota=r.nota||"",a.fecha=r.fecha?r.fecha.substring(0,10):"",a.costo=r.costo!=null?r.costo:r.producto?.costo!=null?r.producto.costo:null,a.costo_usd=r.costo_usd!=null?r.costo_usd:r.producto?.costo_usd!=null?r.producto.costo_usd:null,f.value=r.producto||null):(a.id_producto=null,a.cantidadEntrada=null,a.nota="",a.fecha="",a.costo=null,a.costo_usd=null,f.value=null)},{immediate:!0});function K(r){f.value=r,a.costo=r?.costo!=null?r.costo:null,a.costo_usd=r?.costo_usd!=null?r.costo_usd:null}async function Q(){if(g.value=[],a.id_producto||g.value.push("Debe seleccionar un producto"),(a.cantidadEntrada==null||Number(a.cantidadEntrada)<=0)&&g.value.push("La cantidad debe ser mayor que 0"),a.fecha||g.value.push("Debe seleccionar una fecha"),g.value.length)return;const r={id_producto:a.id_producto,cantidadEntrada:Number(a.cantidadEntrada),nota:a.nota,fecha:a.fecha};if(a.costo!==null&&a.costo!==""){const t=Number(a.costo);isNaN(t)||(r.costo=t)}if(a.costo_usd!==null&&a.costo_usd!==""){const t=Number(a.costo_usd);isNaN(t)||(r.costo_usd=t)}if(h.submitHandler&&typeof h.submitHandler=="function"){try{v.value=!0;const t=await h.submitHandler(r);t&&t.id_producto?await rt(t):(console.warn("ERROR: La entrada creada no tiene id_producto. created:",t,"payload:",r),g.value.push("Error: La entrada fue creada pero sin ID de producto. La confirmación del costo fue cancelada."),v.value=!1)}catch(t){console.error("Error en onSubmit:",t),g.value.push(t.message||"Error al crear la entrada"),v.value=!1}return}C("submit",r)}async function rt(r){const t=r.id_producto||a.id_producto;if(!t){g.value.push("No se pudo obtener el ID del producto. La entrada fue creada pero sin cálculo de costo promedio."),v.value=!1;return}const d=mt(),I=localStorage.getItem("token"),L=[`${d.public.backendHost}/Producto/getProducto/${t}`,`${d.public.backendHost}/Producto/${t}`,`${d.public.backendHost}/Producto/Get/${t}`];let A=null;for(const U of L)try{const M=await fetch(U,{method:"GET",headers:{Authorization:I,Accept:"application/json"}});if(M.ok){const G=await M.json();if(A=G&&G.data?G.data:G,A)break}else console.log(`Respuesta no ok: ${M.status}`)}catch(M){console.log(`Error en obtener producto desde ${U}:`,M)}if(!A){g.value.push("No se pudo obtener los datos del producto. Verifique la conexión e intente nuevamente o cierre este modal."),v.value=!1;return}const H=Number(r.cantidadEntrada!=null?r.cantidadEntrada:a.cantidadEntrada)||0,F=(Number(A.cantidadExistencia)||0)-H,Y=Number(A.costo)||0,ot=Number(A.costo_usd)||0,at=Number(r.costo!=null?r.costo:a.costo)||0,st=Number(r.costo_usd!=null?r.costo_usd:a.costo_usd)||0,J=F+H,lt=J>0?(F*Y+H*at)/J:at,dt=J>0?(F*ot+H*st)/J:st;m.id_producto=t,m.nombre_producto=A.nombre||`Producto ${t}`,m.currentCosto=Y,m.currentCostoUsd=ot,m.suggestedCosto=lt,m.suggestedCostoUsd=dt,m.existingQty=F,m.entryQty=H,_.value=!0,v.value=!1}it(_,async r=>{if(r){await wt();try{const t=j.value,d=t&&t.parentElement?t.parentElement:null;d&&typeof d.scrollTo=="function"?d.scrollTo({top:0,behavior:"smooth"}):t&&typeof t.scrollIntoView=="function"&&t.scrollIntoView({behavior:"smooth",block:"start"})}catch{}}});function tt(){_.value||C("update:modelValue",!1)}async function q(){const r=m.id_producto;if(!r)return;const t=mt(),d=localStorage.getItem("token"),I={costo:Number(m.suggestedCosto).toFixed(5),costo_usd:Number(m.suggestedCostoUsd).toFixed(5)};try{v.value=!0;const L=`${t.public.backendHost}/Producto/updateProducto/${r}`;(await fetch(L,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:d,Accept:"application/json"},body:JSON.stringify(I)})).ok?$.value={title:"Producto actualizado",description:"Se actualizó el costo del producto con el nuevo costo promedio.",type:"success"}:$.value={title:"Actualización fallida",description:"No se pudo actualizar el costo del producto.",type:"warning"}}catch(L){$.value={title:"Error",description:L.message||"Error al actualizar producto",type:"error"}}finally{_.value=!1,v.value=!1,C("success",{title:"Entrada creada",description:"Entrada agregada con éxito"}),C("update:modelValue",!1)}}function X(){_.value=!1,C("success",{title:"Entrada creada",description:"Entrada agregada con éxito"}),C("update:modelValue",!1)}it(()=>h.modelValue,r=>{if(r){try{const t=localStorage.getItem("config");if(t){const d=JSON.parse(t);d&&d.cambio_moneda&&(N.value=Number(d.cambio_moneda)||1)}}catch{N.value=1}!h.isEditing&&!h.isViewing&&(a.id_producto=null,a.cantidadEntrada=null,a.nota="",a.fecha="",a.costo=null,a.costo_usd=null,f.value=null,g.value=[])}else g.value=[]},{immediate:!1});function O(r){const t=r.target.value;if(a.costo=t,!t)return;const d=Number(t);isNaN(d)||!N.value||(a.costo_usd=(d/N.value).toFixed(5))}function et(r){const t=r.target.value;if(a.costo_usd=t,!t)return;const d=Number(t);isNaN(d)||!N.value||(a.costo=(d*N.value).toFixed(5))}return(r,t)=>(y(),ht(At,{show:l.modelValue,onClose:tt,size:"2xl"},{title:ut(()=>[e("h3",Vt,i(l.isViewing?"Detalles de la Entrada":l.isEditing?"Editar Entrada":"Nueva Entrada"),1)]),content:ut(()=>[e("div",{ref_key:"contentWrapper",ref:j,class:Et(["transition-opacity",v.value&&"pointer-events-none opacity-50"])},[v.value?(y(),x("div",Dt,[...t[5]||(t[5]=[e("div",{class:"bg-white rounded-lg p-8 shadow-xl flex flex-col items-center gap-4"},[e("div",{class:"w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin"}),e("p",{class:"text-gray-700 font-medium"},"Procesando, espere...")],-1)])])):S("",!0),$.value?(y(),x("div",It,[P(yt,{title:$.value.title,description:$.value.description,type:$.value.type,onClose:t[0]||(t[0]=d=>$.value=null)},null,8,["title","description","type"])])):S("",!0),_.value?(y(),x("div",Tt,[P(kt,{title:`¿Actualizar costo del producto ${m.nombre_producto}?`,description:`Costo actual: CUP ${Number(m.currentCosto).toFixed(5)} - USD ${Number(m.currentCostoUsd).toFixed(5)}.
Costo sugerido: CUP ${Number(m.suggestedCosto).toFixed(5)} - USD ${Number(m.suggestedCostoUsd).toFixed(5)}.
Existencia actual: ${m.existingQty}, entrada: ${m.entryQty}.`,icon:"",type:"warning",onConfirm:q,onClose:X},null,8,["title","description"])])):S("",!0),l.isViewing?(y(),x("div",jt,[e("div",zt,[t[13]||(t[13]=e("h4",{class:"text-md font-medium text-gray-900 mb-3"},"Información del Producto",-1)),e("div",Lt,[e("div",null,[t[6]||(t[6]=e("label",{class:"block text-sm font-medium text-gray-700"},"Nombre",-1)),e("p",Ot,i(l.entrada.producto?.nombre||"N/A"),1)]),e("div",null,[t[7]||(t[7]=e("label",{class:"block text-sm font-medium text-gray-700"},"Unidad de Medida",-1)),e("p",Ht,i(l.entrada.producto?.unidadMedida||"N/A"),1)]),e("div",null,[t[8]||(t[8]=e("label",{class:"block text-sm font-medium text-gray-700"},"Tipo de Producto",-1)),e("p",Mt,i(l.entrada.producto?.tipoProducto||"N/A"),1)]),e("div",null,[t[9]||(t[9]=e("label",{class:"block text-sm font-medium text-gray-700"},"Precio Unitario",-1)),e("p",Bt,"$"+i(Number(l.entrada.producto?.precio||0).toFixed(5)),1)]),e("div",null,[t[10]||(t[10]=e("label",{class:"block text-sm font-medium text-gray-700"},"Costo USD",-1)),e("p",Rt,"$"+i(Number(l.entrada.producto?.costo_usd||0).toFixed(5)),1)]),e("div",null,[t[11]||(t[11]=e("label",{class:"block text-sm font-medium text-gray-700"},"Existencia Actual",-1)),e("p",Kt,i(l.entrada.producto?.cantidadExistencia||0),1)])]),e("div",Qt,[t[12]||(t[12]=e("label",{class:"block text-sm font-medium text-gray-700"},"Nota del Producto",-1)),e("p",qt,i(l.entrada.producto?.nota||"Sin nota"),1)])]),e("div",Jt,[t[20]||(t[20]=e("h4",{class:"text-md font-medium text-gray-900 mb-3"},"Información de la Entrada",-1)),e("div",Gt,[e("div",null,[t[14]||(t[14]=e("label",{class:"block text-sm font-medium text-gray-700"},"Cantidad Entrada",-1)),e("p",Wt,i(l.entrada.cantidadEntrada),1)]),e("div",null,[t[15]||(t[15]=e("label",{class:"block text-sm font-medium text-gray-700"},"Costo",-1)),e("p",Xt,"$"+i(Number(l.entrada.costo||0).toFixed(5)),1)]),e("div",null,[t[16]||(t[16]=e("label",{class:"block text-sm font-medium text-gray-700"},"Costo USD",-1)),e("p",Yt,"$"+i(Number(l.entrada.costo_usd||l.entrada.producto?.costo_usd||0).toFixed(5)),1)]),e("div",null,[t[17]||(t[17]=e("label",{class:"block text-sm font-medium text-gray-700"},"Total",-1)),e("p",Zt,"$"+i((Number(l.entrada.cantidadEntrada)*Number(l.entrada.producto?.precio||0)).toFixed(5)),1)]),e("div",null,[t[18]||(t[18]=e("label",{class:"block text-sm font-medium text-gray-700"},"Fecha",-1)),e("p",te,i(l.entrada.fecha?new Date(l.entrada.fecha).toLocaleDateString("es-ES"):"N/A"),1)])]),e("div",ee,[t[19]||(t[19]=e("label",{class:"block text-sm font-medium text-gray-700"},"Nota de la Entrada",-1)),e("p",oe,i(l.entrada.nota||"Sin nota"),1)])]),l.entrada.contrato?(y(),x("div",ae,[t[26]||(t[26]=e("h4",{class:"text-md font-medium text-gray-900 mb-3"},"Información del Contrato",-1)),e("div",se,[e("div",null,[t[21]||(t[21]=e("label",{class:"block text-sm font-medium text-gray-700"},"Número Consecutivo",-1)),e("p",ne,i(l.entrada.contrato?.num_consecutivo||"N/A"),1)]),e("div",null,[t[22]||(t[22]=e("label",{class:"block text-sm font-medium text-gray-700"},"Cliente o Proveedor",-1)),e("p",re,i(l.entrada.contrato?.ClienteOProveedor||"N/A"),1)]),e("div",null,[t[23]||(t[23]=e("label",{class:"block text-sm font-medium text-gray-700"},"Fecha Inicio",-1)),e("p",le,i(l.entrada.contrato?.fecha_inicio?new Date(l.entrada.contrato.fecha_inicio).toLocaleDateString("es-ES"):"N/A"),1)]),e("div",null,[t[24]||(t[24]=e("label",{class:"block text-sm font-medium text-gray-700"},"Fecha Fin",-1)),e("p",de,i(l.entrada.contrato?.fecha_fin?new Date(l.entrada.contrato.fecha_fin).toLocaleDateString("es-ES"):"N/A"),1)])]),e("div",ie,[t[25]||(t[25]=e("label",{class:"block text-sm font-medium text-gray-700"},"Nota del Contrato",-1)),e("p",ue,i(l.entrada.contrato?.nota||"Sin nota"),1)])])):S("",!0),l.entrada.factura?(y(),x("div",ce,[t[31]||(t[31]=e("h4",{class:"text-md font-medium text-gray-900 mb-3"},"Información de Factura",-1)),e("div",me,[e("div",null,[t[27]||(t[27]=e("label",{class:"block text-sm font-medium text-gray-700"},"Número Consecutivo",-1)),e("p",pe,i(l.entrada.factura?.num_consecutivo||"N/A"),1)]),e("div",null,[t[28]||(t[28]=e("label",{class:"block text-sm font-medium text-gray-700"},"Estado",-1)),e("p",fe,i(l.entrada.factura?.estado||"N/A"),1)]),e("div",null,[t[29]||(t[29]=e("label",{class:"block text-sm font-medium text-gray-700"},"Fecha",-1)),e("p",ge,i(l.entrada.factura?.fecha?new Date(l.entrada.factura.fecha).toLocaleDateString("es-ES"):"N/A"),1)]),e("div",null,[t[30]||(t[30]=e("label",{class:"block text-sm font-medium text-gray-700"},"Importe Total",-1)),e("p",ve,"$"+i(Number(l.entrada.factura?.suma_general||0).toFixed(5)),1)])])])):S("",!0),e("div",be,[t[34]||(t[34]=e("h4",{class:"text-md font-medium text-gray-900 mb-3"},"Información del Sistema",-1)),e("div",ye,[e("div",null,[t[32]||(t[32]=e("label",{class:"block text-sm font-medium text-gray-700"},"Creado",-1)),e("p",xe,i(l.entrada.createdAt?new Date(l.entrada.createdAt).toLocaleString("es-ES"):"N/A"),1)]),e("div",null,[t[33]||(t[33]=e("label",{class:"block text-sm font-medium text-gray-700"},"Última Actualización",-1)),e("p",ke,i(l.entrada.updatedAt?new Date(l.entrada.updatedAt).toLocaleString("es-ES"):"N/A"),1)])])])])):(y(),x("div",we,[e("div",he,[e("div",null,[t[35]||(t[35]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Producto",-1)),P(xt,{modelValue:a.id_producto,"onUpdate:modelValue":t[1]||(t[1]=d=>a.id_producto=d),endpoint:"/Producto/filterProductos/1/10",method:"POST","search-key":"nombre","label-key":"nombre","value-key":"id_producto",placeholder:"Buscar producto...",onProductoSeleccionado:K},null,8,["modelValue"])]),e("div",null,[t[36]||(t[36]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha",-1)),V(e("input",{type:"date","onUpdate:modelValue":t[2]||(t[2]=d=>a.fecha=d),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary"},null,512),[[D,a.fecha]])]),e("div",null,[t[37]||(t[37]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Costo",-1)),e("input",{type:"number",step:"any",value:a.costo,onInput:O,placeholder:"Costo...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary"},null,40,Ee)]),e("div",null,[t[38]||(t[38]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Costo USD",-1)),e("input",{type:"number",step:"any",value:a.costo_usd,onInput:et,placeholder:"Costo USD...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary"},null,40,Ce)]),e("div",null,[t[39]||(t[39]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Cantidad",-1)),V(e("input",{type:"number","onUpdate:modelValue":t[3]||(t[3]=d=>a.cantidadEntrada=d),min:"0",step:"any",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary"},null,512),[[D,a.cantidadEntrada,void 0,{number:!0}]])]),e("div",null,[t[40]||(t[40]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Costos * Cantidad",-1)),e("input",{type:"text",readonly:"",value:`CUP: ${R.value} - USD: ${z.value}`,class:"w-full px-4 py-2 rounded-lg border border-gray-200 bg-gray-50 text-gray-700"},null,8,Ne)]),e("div",Se,[t[41]||(t[41]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Nota",-1)),V(e("input",{type:"text","onUpdate:modelValue":t[4]||(t[4]=d=>a.nota=d),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Nota..."},null,512),[[D,a.nota]])])]),f.value?(y(),x("div",_e,[t[50]||(t[50]=e("h4",{class:"text-md font-medium text-gray-900 mb-3"},"Información del Producto",-1)),e("div",$e,[e("div",null,[t[42]||(t[42]=e("div",{class:"text-sm text-gray-600"},"Existencia",-1)),e("div",Ue,i(f.value.cantidadExistencia||0),1)]),e("div",null,[t[43]||(t[43]=e("div",{class:"text-sm text-gray-600"},"Unidad",-1)),e("div",Pe,i(f.value.unidadMedida),1)]),e("div",null,[t[44]||(t[44]=e("div",{class:"text-sm text-gray-600"},"Tipo",-1)),e("div",Ae,i(f.value.tipoProducto),1)]),e("div",null,[t[45]||(t[45]=e("div",{class:"text-sm text-gray-600"},"Precio",-1)),e("div",Fe,i(Number(f.value.precio||0).toFixed(5)),1)]),e("div",null,[t[46]||(t[46]=e("div",{class:"text-sm text-gray-600"},"Costo",-1)),e("div",Ve,i(Number(f.value.costo||0).toFixed(5)),1)]),e("div",null,[t[47]||(t[47]=e("div",{class:"text-sm text-gray-600"},"Costo USD",-1)),e("div",De,i(Number(f.value.costo_usd||0).toFixed(5)),1)])]),e("div",Ie,[e("div",null,[t[48]||(t[48]=e("div",{class:"text-sm text-gray-600"},"Precio × Cantidad",-1)),e("div",Te,i((Number(f.value.precio||0)*Number(a.cantidadEntrada||0)).toFixed(5)),1)]),e("div",null,[t[49]||(t[49]=e("div",{class:"text-sm text-gray-600"},"Costo × Cantidad",-1)),e("div",je,i((Number(f.value.costo||0)*Number(a.cantidadEntrada||0)).toFixed(5)),1)])])])):S("",!0),g.value.length?(y(),x("div",ze,[(y(!0),x(Ct,null,Nt(g.value,(d,I)=>(y(),x("div",{key:I},i(d),1))),128))])):S("",!0)]))],2)]),footer:ut(()=>[e("div",Le,[l.isViewing?S("",!0):(y(),x("button",{key:0,onClick:Q,disabled:v.value,class:"px-4 py-2 bg-primary text-neutral rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-all"},i(v.value?l.isEditing?"Guardando...":"Creando...":l.isEditing?"Guardar":"Crear"),9,Oe)),e("button",{onClick:tt,disabled:v.value,class:"px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"},"Cerrar",8,He)])]),_:1},8,["show"]))}},Be={class:"min-h-screen bg-gradient-to-br via-secondary/40 from-accent/30 to-neutral"},Re={key:0,class:"fixed top-6 left-1/2 transform -translate-x-1/2 z-[9999] w-full max-w-md px-4 pointer-events-none"},Ke={key:1,class:"fixed top-24 left-1/2 transform -translate-x-1/2 z-[10000] w-full max-w-md px-4 pointer-events-auto"},Qe={class:"w-[95%] mx-auto px-4 py-4 md:py-4 mt-20 md:mt-0"},qe={class:"bg-white rounded-lg shadow-md p-4"},Je={class:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"},Ge={class:"w-full"},We={class:"w-full"},Xe={class:"w-full"},Ye={class:"w-full"},Ze={class:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"},to={class:"w-full"},eo={class:"w-full"},oo={class:"w-full md:col-span-2"},ao={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"},so={class:"w-full"},no={class:"w-full"},ro={class:"flex justify-end mt-4 gap-2 flex-wrap"},lo={class:"w-[95%] mx-auto px-4 py-4"},io={class:"flex justify-between items-center mb-4"},wo={__name:"entradas",setup(l){const T=u(""),h=u(""),C=u(""),a=u(""),f=u(""),g=u(""),v=u(""),_=u(""),m=u(""),$=u([]),j=u(!1),N=u({}),R=u(!1),z=u(!1),K=u(!1),Q=u(null),rt=[{key:"producto.nombre",label:"Producto"},{key:"producto.codigo",label:"Código"},{key:"producto.unidadMedida",label:"Unidad"},{key:"cantidadEntrada",label:"Cantidad"},{key:"costo",label:"Costo Unitario",cellRenderer:(s,o)=>{const n=o.costo!=null?o.costo:o.producto?.costo!=null?o.producto.costo:null;if(n==null||n==="")return"";const p=parseFloat(n);return isNaN(p)?n:`<span class="px-2 py-1 rounded text-sm">${p.toFixed(2)}</span>`}},{key:"costo_usd",label:"Costo USD",cellRenderer:(s,o)=>{const n=o.costo_usd!=null?o.costo_usd:o.producto?.costo_usd!=null?o.producto.costo_usd:null;if(n==null||n==="")return"";const p=parseFloat(n);return isNaN(p)?n:`<span class="px-2 py-1 rounded text-sm">${p.toFixed(5)}</span>`}},{key:"total",label:"Total",cellRenderer:(s,o)=>{const n=parseFloat(o.cantidadEntrada||0),p=parseFloat(o.costo!=null?o.costo:o.producto?.costo||0);return`<span class="px-2 py-1 rounded text-sm font-semibold">${(n*p).toFixed(2)}</span>`}},{key:"total_usd",label:"Total USD",cellRenderer:(s,o)=>{const n=parseFloat(o.cantidadEntrada||0),p=parseFloat(o.costo_usd!=null?o.costo_usd:o.producto?.costo_usd||0),k=n*p;return isNaN(k)?"":`<span class="px-2 py-1 rounded text-sm font-semibold">${k.toFixed(5)}</span>`}},{key:"fecha",label:"Fecha",cellRenderer:s=>s?`<span class="px-2 py-1 rounded text-sm">${s.substring(0,10)}</span>`:""}],tt=Z(()=>rt),q=u(1),X=u(0),O=u(!1),et=u(20),r=u([]),t=u(null),d=mt(),I=Z(()=>{try{const s=localStorage.getItem("usuario");if(!s)return!1;const o=JSON.parse(s),n=o&&(o.rol||o.role||o.perfil&&o.perfil.rol||o.profile&&o.profile.role)?o.rol||o.role||o.perfil&&o.perfil.rol||o.profile&&o.profile.role:null;return n?String(n).trim().toLowerCase()==="invitado":!1}catch{return!1}}),L={render(){return nt("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[nt("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})])}},A=[{name:"Editar",icon:{render(){return nt("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[nt("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})])}},handler:s=>Y(s,"editar"),iconOnly:!1,buttonClass:"px-3 py-1 bg-accent text-neutral rounded-md hover:bg-accent/90",visible:s=>!s.id_contrato&&!s.id_factura||s.id_contrato===""&&s.id_factura===""},{name:"Eliminar",icon:L,handler:s=>st(s),iconOnly:!1,buttonClass:"px-3 py-1 bg-danger text-neutral rounded-md hover:bg-danger/90",visible:s=>!s.id_contrato&&!s.id_factura||s.id_contrato===""&&s.id_factura===""}];async function H(){try{const s=localStorage.getItem("token"),n=await(await fetch(`${d.public.backendHost}/contrato`,{method:"GET",headers:{Authorization:s,Accept:"application/json"}})).json();$.value=Array.isArray(n.data)?n.data.map(p=>({...p,displayLabel:`${p.num_consecutivo} - ${p.entidad?.nombre||""} - ${p.tipoContrato?.nombre||""}`})):[]}catch(s){console.error("Error al cargar contratos:",s)}}async function F(s=1){const o=localStorage.getItem("token");if(!o){W("/");return}try{O.value=!0;const n={nota:v.value||"",fecha_desde:_.value||"",fecha_hasta:m.value||""};T.value!==""&&(n.id_producto=T.value),h.value!==""&&(n.id_contrato=h.value),(C.value!==""||a.value!=="")&&(n.cantidadEntrada={min:C.value||0,max:a.value||0}),(f.value!==""||g.value!=="")&&(n.costo={min:f.value||0,max:g.value||0}),console.log(n);const p=await fetch(`${d.public.backendHost}/entrada/filterEntradas/${s}/${et.value}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:o},body:JSON.stringify(n)});if(p.status===401){t.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{W("/")},3e3);return}if(p.status===403){t.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"};return}const k=await p.json();r.value=k.data||[],X.value=k.pagination?.total||0,q.value=k.pagination?.currentPage||1}catch{t.value={title:"Error",description:"No se pudieron cargar las entradas",type:"error"}}finally{O.value=!1}}function Y(s,o){if((s.id_factura||s.id_contrato)&&o!=="ver"){t.value={title:"Entrada no editable",description:"Esta entrada fue creada por una factura de un proveedor, solo es editable desde la factura misma",type:"warning"};return}N.value={...s},R.value=o==="ver",z.value=o==="editar",j.value=!0}function ot(s){Y(s,"ver")}function at(){N.value=null,R.value=!1,z.value=!1,j.value=!0}function st(s){if(s.id_factura||s.id_contrato){t.value={title:"Entrada no eliminable",description:"Esta entrada fue creada por una factura de un proveedor, solo es eliminable desde la factura misma",type:"warning"};return}Q.value=s,K.value=!0}async function J(){if(Q.value)try{const s=localStorage.getItem("token"),o=await fetch(`${d.public.backendHost}/Entrada/deleteEntrada/${Q.value.id_entrada}`,{method:"DELETE",headers:{Authorization:s,Accept:"application/json"}});if(o.status===401){t.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{W("/")},3e3);return}if(o.status===403){t.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"};return}if(!o.ok){const n=await o.json().catch(()=>({})),p=Array.isArray(n.errors)?n.errors.join(`
`):n.error||"No se pudo eliminar la entrada";t.value={title:"Error",description:p,type:"error"};return}t.value={title:"Entrada eliminada",description:"Se eliminó correctamente",type:"success"},await F(q.value)}catch{t.value={title:"Error",description:"Ocurrió un error al eliminar",type:"error"}}finally{K.value=!1,Q.value=null}}async function lt(s){try{const o=localStorage.getItem("token"),n=z.value&&N.value?.id_entrada?`${d.public.backendHost}/Entrada/updateEntrada/${N.value.id_entrada}`:`${d.public.backendHost}/Entrada/createEntrada`,p=z.value?"PUT":"POST";console.log("createEntrada - Enviando payload:",s);const k=await fetch(n,{method:p,headers:{"Content-Type":"application/json",Authorization:o,Accept:"application/json"},body:JSON.stringify(s)});if(k.status===401)throw t.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{W("/")},3e3),new Error("Sesión Expirada");if(k.status===403)throw t.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"},new Error("Acceso Denegado");let c=null;try{c=await k.json()}catch{c=null}if(!k.ok){let w="Error desconocido";throw c&&c.errors&&Array.isArray(c.errors)?w=c.errors.join(`
• `):c&&typeof c.error=="string"?w=c.error:c&&(c.message||c.description)?w=c.message||c.description:c&&(w=JSON.stringify(c)),t.value={title:`Error ${k.status}`,description:w,type:"error"},new Error(w)}let E=null;if(c)E=c&&c.data?c.data:c;else try{const w=await k.json();E=w&&w.data?w.data:w}catch{E=null}return console.log("createEntrada - Response data:",c),console.log("createEntrada - Created object:",E),E&&!E.id_producto&&s.id_producto&&(console.log("Agregando id_producto al objeto creado:",s.id_producto),E.id_producto=s.id_producto),(!E||!E.id_producto)&&console.warn("ADVERTENCIA: El objeto creado no tiene id_producto. created:",E,"payload:",s),E}catch(o){throw console.error("Error en createEntrada:",o),o}}async function dt(s){try{t.value={title:s?.title||"Entrada creada",description:s?.description||"",type:"success"},j.value=!1,N.value={},z.value=!1,R.value=!1,await F(q.value)}catch(o){console.error(o)}}const U=async()=>{try{O.value=!0,await F(1)}catch(s){console.error("Error al buscar entradas:",s)}finally{O.value=!1}};function M(s){F(s)}async function G(){t.value={title:"Consultando datos",description:"Se están consultando los datos, la descarga comenzará en breve.",type:"info"};try{const s=localStorage.getItem("token"),o={nota:v.value||"",fecha_desde:_.value||"",fecha_hasta:m.value||""};T.value!==""&&(o.id_producto=T.value),h.value!==""&&(o.id_contrato=h.value),(C.value!==""||a.value!=="")&&(o.cantidadEntrada={min:C.value||0,max:a.value||0}),(f.value!==""||g.value!=="")&&(o.costo={min:f.value||0,max:g.value||0});const n=await fetch(`${d.public.backendHost}/entrada/filterEntradas/1/${X.value}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:s,Accept:"application/json"},body:JSON.stringify(o)});if(n.status===401){t.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{W("/")},3e3);return}if(n.status===403){t.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"};return}if(!n.ok){const b=await n.json();t.value={title:"Error al consultar datos",description:b.error||"Ocurrió un error al consultar los datos.",type:"error"};return}const k=(await n.json()).data.map(b=>{const pt=Number(b.costo!=null?b.costo:b.producto?.costo||0),ft=Number(b.costo_usd!=null?b.costo_usd:b.producto?.costo_usd||0),gt=Number(b.cantidadEntrada||0);return{Producto:b.producto?.nombre||"",Código:b.producto?.codigo||"",Unidad:b.producto?.unidadMedida||"",Cantidad:b.cantidadEntrada,"Costo Unitario":pt.toFixed(2),"Costo USD":ft.toFixed(5),Total:(gt*pt).toFixed(2),"Total USD":(gt*ft).toFixed(5),Fecha:b.fecha?b.fecha.substring(0,10):"",Nota:b.nota||"",Contrato:b.contrato?.num_consecutivo||"",Entidad:b.contrato?.entidad?.nombre||""}}),c=ct.json_to_sheet(k),E=ct.book_new();ct.book_append_sheet(E,c,"Entradas");const w=new Date().toISOString().split("T")[0];Ft(E,`entradas_${w}.xlsx`),t.value=null}catch(s){console.error("Error al exportar a Excel:",s),t.value={title:"Error",description:"Ocurrió un error al exportar los datos.",type:"error"}}}return St(async()=>{if(!localStorage.getItem("token")){W("/");return}await H(),await F()}),(s,o)=>(y(),x("div",Be,[P($t,{title:"Entradas - Pactum",description:"Lista y gestión de entradas de productos.",canonical:"/entradas"}),P(_t),t.value?(y(),x("div",Re,[P(yt,{title:t.value.title,description:t.value.description,type:t.value.type,onClose:o[0]||(o[0]=n=>t.value=null),class:"pointer-events-auto"},null,8,["title","description","type"])])):S("",!0),K.value?(y(),x("div",Ke,[P(kt,{title:"¿Estás seguro que deseas eliminar esta entrada?",description:"Esta acción no se puede deshacer.",icon:L,type:"warning",onConfirm:J,onClose:o[1]||(o[1]=n=>K.value=!1)})])):S("",!0),e("div",Qe,[e("div",qe,[e("div",Je,[e("div",Ge,[o[12]||(o[12]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Producto por código",-1)),P(xt,{modelValue:T.value,"onUpdate:modelValue":o[2]||(o[2]=n=>T.value=n),endpoint:"/Producto/filterProductos/1/10",method:"POST","search-key":"codigo","label-key":"codigo","value-key":"id_producto",placeholder:"Buscar producto por código..."},null,8,["modelValue"])]),e("div",We,[o[13]||(o[13]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Contrato por número consecutivo",-1)),P(Pt,{modelValue:h.value,"onUpdate:modelValue":o[3]||(o[3]=n=>h.value=n),options:$.value,labelKey:"displayLabel",valueKey:"id_contrato",placeholder:"Buscar contrato..."},null,8,["modelValue","options"])]),e("div",Xe,[o[14]||(o[14]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Cantidad mínima",-1)),V(e("input",{type:"number","onUpdate:modelValue":o[4]||(o[4]=n=>C.value=n),placeholder:"Cantidad min...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:B(U,["enter"])},null,544),[[D,C.value,void 0,{number:!0}]])]),e("div",Ye,[o[15]||(o[15]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Cantidad máxima",-1)),V(e("input",{type:"number","onUpdate:modelValue":o[5]||(o[5]=n=>a.value=n),placeholder:"Cantidad max...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:B(U,["enter"])},null,544),[[D,a.value,void 0,{number:!0}]])])]),e("div",Ze,[e("div",to,[o[16]||(o[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Costo mínimo",-1)),V(e("input",{type:"number","onUpdate:modelValue":o[6]||(o[6]=n=>f.value=n),step:"any",placeholder:"Costo min...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:B(U,["enter"])},null,544),[[D,f.value,void 0,{number:!0}]])]),e("div",eo,[o[17]||(o[17]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Costo máximo",-1)),V(e("input",{type:"number","onUpdate:modelValue":o[7]||(o[7]=n=>g.value=n),step:"any",placeholder:"Costo max...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:B(U,["enter"])},null,544),[[D,g.value,void 0,{number:!0}]])]),e("div",oo,[o[18]||(o[18]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Nota",-1)),V(e("input",{type:"text","onUpdate:modelValue":o[8]||(o[8]=n=>v.value=n),placeholder:"Nota...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:B(U,["enter"])},null,544),[[D,v.value]])])]),e("div",ao,[e("div",so,[o[19]||(o[19]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha desde",-1)),V(e("input",{type:"date","onUpdate:modelValue":o[9]||(o[9]=n=>_.value=n),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:B(U,["enter"])},null,544),[[D,_.value]])]),e("div",no,[o[20]||(o[20]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha hasta",-1)),V(e("input",{type:"date","onUpdate:modelValue":o[10]||(o[10]=n=>m.value=n),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:B(U,["enter"])},null,544),[[D,m.value]])])]),e("div",ro,[e("button",{onClick:U,class:"px-6 py-2 bg-primary text-neutral rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors"}," Buscar "),I.value?S("",!0):(y(),x("button",{key:0,onClick:G,class:"px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors flex items-center"},[...o[21]||(o[21]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 12h2v2H7v-2zM11 12h2v2h-2v-2zM15 12h2v2h-2v-2z"})],-1),bt(" Exportar a Excel ",-1)])]))])])]),e("div",lo,[e("div",io,[o[23]||(o[23]=e("h2",{class:"text-2xl font-bold"},"Entradas",-1)),I.value?S("",!0):(y(),x("button",{key:0,onClick:at,class:"px-4 py-2 bg-primary text-neutral rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary flex items-center"},[...o[22]||(o[22]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),bt(" Nueva Entrada ",-1)])]))]),P(Ut,{columns:tt.value,items:r.value,actions:I.value?[]:A,"total-items":X.value,"items-per-page":et.value,"current-page":q.value,"is-loading":O.value,onPageChange:M,onRowClick:ot},null,8,["columns","items","actions","total-items","items-per-page","current-page","is-loading"])]),P(Me,{modelValue:j.value,"onUpdate:modelValue":o[11]||(o[11]=n=>j.value=n),entrada:N.value,"is-editing":z.value,"is-viewing":R.value,submitHandler:lt,onSuccess:dt},null,8,["modelValue","entrada","is-editing","is-viewing"])]))}};export{wo as default};
