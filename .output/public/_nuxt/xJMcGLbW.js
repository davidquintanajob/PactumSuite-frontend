import{_ as ve,r as c,o as fe,k as R,q as G,n as xe,y as f,C as W,A as e,F as Z,H as pe,X as ee,B as v,E as m,K as te,L as se,O as ae,P as oe,z as x}from"#entry";import{N as ge}from"./DTHag2Fn.js";import{S as he}from"./CC2Sf2Ne.js";import"./BzLCLO6P.js";const be={class:"min-h-screen bg-gradient-to-br via-secondary/40 from-accent/30 to-neutral"},ye={class:"w-[95%] mx-auto px-4 py-6 mt-20 md:mt-6"},_e={class:"bg-white rounded-lg shadow-md p-4"},we={class:"flex flex-col md:flex-row md:items-center md:gap-6 gap-4"},Se={class:"relative"},ke={key:0,class:"absolute top-10 right-0 bg-white text-sm text-gray-700 p-2 rounded shadow w-56 z-20"},Ie={class:"mt-6 bg-white rounded-lg shadow-md p-6 h-[80vh] flex flex-col"},De={class:"flex-1 border-2 border-dashed border-gray-200 rounded p-4 text-gray-400"},Te={key:0,class:"flex flex-col md:flex-row items-center justify-center"},Fe={class:"w-full md:w-1/2 flex flex-col items-center justify-center p-4"},Me={key:0,class:"text-center"},je={key:1,class:"relative w-48 h-48 md:w-64 md:h-64 max-w-full"},Ae={key:0,class:"fixed inset-0 z-[20000] flex items-center justify-center bg-black/60"},Ee={class:"bg-white rounded-lg p-6 w-full max-w-lg mx-4"},$e={class:"w-full bg-gray-100 rounded h-3 overflow-hidden mb-3"},Ce={class:"text-sm text-gray-600"},Ve={class:"w-full md:w-1/2 p-4 overflow-hidden"},Ne={class:"flex flex-col gap-4"},Pe={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},Be={class:"font-semibold text-right"},Re={class:"text-sm text-gray-500"},Ue={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},ze={class:"font-semibold text-right"},He={class:"text-sm text-gray-500"},Oe={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},Ge={class:"font-semibold text-right"},Le={class:"text-sm text-gray-500"},Ye={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},Je={class:"font-semibold text-right"},qe={class:"text-sm text-gray-500"},Ke={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},Xe={class:"font-semibold text-right"},Qe={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},We={class:"font-semibold text-right"},Ze={class:"flex items-start justify-between flex-col sm:flex-row gap-2 sm:gap-0"},et={class:"font-semibold text-right"},tt={key:1,class:"w-full flex flex-col items-center justify-start p-4 gap-4"},st={class:"w-full max-w-xl flex flex-col sm:flex-row gap-3 items-stretch"},at={class:"flex-1"},ot={class:"flex-1"},nt={class:"w-full mt-4"},lt={key:0,class:"text-center py-6"},rt={key:1,class:"text-center text-sm text-red-600"},it={key:2,class:"text-center text-sm text-gray-600"},ct={key:3,class:"w-full overflow-auto"},dt={viewBox:"0 0 100 50",class:"w-full h-40"},ut=["points"],mt=["cx","cy"],vt={class:"mt-2 text-xs text-gray-600 flex flex-wrap gap-2"},L=5,ft={__name:"informes",setup(xt){const V=c(!1),ne=c(!1),F=c("A");function le(a){a.stopPropagation(),V.value=!V.value,V.value&&(ne.value=!1)}function re(a){a!==F.value&&(F.value=a,q())}const M=c(""),j=c(""),U=c(!1),h=c([]),N=c(null);function Y(a){const s=a.getFullYear(),o=String(a.getMonth()+1).padStart(2,"0"),d=String(a.getDate()).padStart(2,"0");return`${s}-${o}-${d}`}function ie(){const a=new Date,s=new Date(a.getFullYear(),a.getMonth()-1,1),o=new Date(a.getFullYear(),a.getMonth(),0);M.value=Y(s),j.value=Y(o)}function ce(){N.value=null,h.value=[],U.value=!0,(async()=>{try{const a=new Date(M.value+"T00:00:00").toISOString(),s=new Date(j.value+"T23:59:59").toISOString(),o=localStorage.getItem("token"),d={fecha_hora_min:a,fecha_hora_max:s},l=await fetch(`${I.public.backendHost}/Venta/filter/1/999999999`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:o},body:JSON.stringify(d)});if(l.status===401){localStorage.removeItem("token"),G("/login");return}if(!l.ok){const i=await l.text();throw new Error(i||`HTTP ${l.status}`)}const u=await l.json(),t=u&&u.data?u.data:[],n={};for(const i of t){const k=i.fecha_hora?new Date(i.fecha_hora):i.createdAt?new Date(i.createdAt):null;if(!k)continue;const K=k.getFullYear()+"-"+String(k.getMonth()+1).padStart(2,"0")+"-"+String(k.getDate()).padStart(2,"0"),X=Number(i.precio_cobrado)||0,Q=Number(i.cantidad)||0,O=Number(i.cambioUSD_al_vender)||1,me=O&&O!==0?X*Q/O:X*Q;n[K]=(n[K]||0)+me}const r=[],p=new Date(M.value+"T00:00:00"),y=new Date(j.value+"T00:00:00");for(let i=new Date(p);i<=y;i.setDate(i.getDate()+1)){const k=i.getFullYear()+"-"+String(i.getMonth()+1).padStart(2,"0")+"-"+String(i.getDate()).padStart(2,"0");r.push(k)}const _=r.map((i,k)=>({day:i,value:+(n[i]||0),idx:k}));h.value=_}catch(a){console.error("Informe B error:",a),N.value=a&&a.message?a.message:String(a)}finally{U.value=!1}})()}fe(()=>{F.value="A",q(),ie()});const I=xe(),z=c(!1),A=c(0),E=c(0),D=c(0),$=c(0),T=c(0),C=c(0),H=c(!1),b=c(0),w=c(!1),S=c(""),J=R(()=>Math.min(100,Math.round(b.value/L*100)));async function P(a,s){const o=await fetch(a,{method:"GET",headers:{Accept:"application/json",Authorization:s}});if(o.status===401)throw localStorage.removeItem("token"),G("/login"),new Error("Unauthorized");if(!o.ok){const d=await o.text();throw new Error(d||`HTTP ${o.status}`)}return o.json()}function g(a){if(a==null||a==="")return 0;const s=Number(a);return isNaN(s)?0:s}async function q(){z.value=!0,H.value=!0,b.value=0,w.value=!1,S.value="",A.value=E.value=D.value=$.value=T.value=C.value=0;try{const a=localStorage.getItem("token");if(!a){G("/login");return}let s=[];try{s=await P(`${I.public.backendHost}/entrada`,a)}catch(t){console.error(t),w.value=!0,S.value="Error consultando entradas"}b.value+=1;try{let t=0;for(const n of s||[]){const r=g(n.cantidadEntrada),p=g(n.costo_usd);t+=r*p}A.value=t}catch(t){console.error(t)}let o=[];try{o=await P(`${I.public.backendHost}/producto`,a)}catch(t){console.error(t),w.value=!0,S="Error consultando productos"}b.value+=1;try{let t=0;for(const n of o||[]){const r=g(n.costo_usd),p=g(n.cantidadExistencia);t+=r*p}E.value=t}catch(t){console.error(t)}let d=[];try{d=await P(`${I.public.backendHost}/venta`,a)}catch(t){console.error(t),w.value=!0,S="Error consultando ventas"}b.value+=1;try{let t=0,n=0;for(const r of d||[]){const p=g(r.precio_cobrado),y=g(r.costo_venta_usd),_=g(r.cantidad),i=g(r.cambioUSD_al_vender)||1;t+=p*_/i,n+=y*_}D.value=t,$.value=n}catch(t){console.error(t)}let l=[];try{l=await P(`${I.public.backendHost}/salida`,a)}catch(t){console.error(t),w.value=!0,S="Error consultando salidas"}b.value+=1;try{let t=0;for(const n of l||[]){const r=g(n.cantidad),p=g(n.costo_producto_usd);t+=r*p}T.value=t}catch(t){console.error(t)}let u=[];try{const t=await fetch(`${I.public.backendHost}/Retiro/filterRetiros/null/null`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:a},body:JSON.stringify({})});if(t.ok){const n=await t.json();u=n&&n.data?n.data:[]}else console.error("retiros fetch status",t.status),w.value=!0,S="Error consultando retiros"}catch(t){console.error(t),w.value=!0,S="Error consultando retiros"}b.value+=1;try{let t=0;for(const n of u||[]){const r=g(n.cantidad_retirada_cup),p=g(n.cantidad_retirada_usd),y=g(n.cambio_moneda)||1,_=y&&y!==0?r/y:r;t+=_+p}C.value=t}catch(t){console.error(t)}}catch(a){console.error("Error generating informe A:",a),w.value=!0,S.value="Ocurrió un error generando el informe"}finally{z.value=!1,H.value=!1,b.value=L}}const de=R(()=>{const a=[A.value,E.value,D.value,T.value],s=["#F97316","#0369A1","#10B981","#EF4444"],o=a.reduce((t,n)=>t+Math.max(0,n),0),d=.6;let l=0;const u=[];if(!o||o<=0)return"conic-gradient(#eef2f7 0% 100%)";for(let t=0;t<a.length;t++){const r=Math.max(0,a[t])/o*100,p=Math.max(0,r-d);if(p>0){const y=l,_=l+p;u.push(`${s[t]} ${y}% ${_}%`),l=_}l+=d,u.push(`transparent ${Math.max(0,l-d)}% ${l}%`)}return l<100&&u.push(`transparent ${l}% 100%`),`conic-gradient(${u.join(", ")})`}),B=R(()=>{const a=[A.value,E.value,D.value,T.value,C.value,$.value],s=a.reduce((o,d)=>o+Math.max(0,d),0)||0;return s===0?a.map(()=>0):a.map(o=>Math.max(0,o)/s*100)}),ue=R(()=>(D.value||0)-($.value||0)-(T.value||0)-(C.value||0));return(a,s)=>(x(),f("div",be,[W(he,{title:"Informes - Pactum",description:"Panel de Informes en Pactum",canonical:"/informes"}),W(ge),e("div",ye,[e("div",_e,[s[3]||(s[3]=e("h2",{class:"text-2xl font-bold mb-4"},"Informes",-1)),e("div",we,[e("div",Se,[e("button",{onClick:s[0]||(s[0]=o=>re("A")),class:pe(["px-6 py-3 rounded-lg transition relative",F.value==="A"?"bg-primary text-neutral hover:bg-primary/90":"bg-white text-gray-700 border"])}," Resumen General de Inventario y Ventas ",2),e("button",{onClick:le,class:"absolute -top-2 -right-2 w-5 h-5 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs shadow","aria-label":"info informe A"},"!"),V.value?(x(),f("div",ke," Muestra gráficamente el resumen de costos de compra, valor del inventario y ventas en USD y resumiendolo todo en la ganancia hasta el momento. ")):Z("",!0)])])]),e("div",Ie,[s[16]||(s[16]=e("h3",{class:"text-xl font-semibold mb-2"},"Vista de Informe",-1)),e("div",De,[F.value==="A"?(x(),f("div",Te,[e("div",Fe,[z.value?(x(),f("div",Me,"Cargando informe...")):(x(),f("div",je,[e("div",{class:"absolute inset-0 rounded-full",style:ee({background:de.value,borderRadius:"9999px",boxShadow:"0 6px 12px rgba(0,0,0,0.08)"})},null,4)]))]),H.value?(x(),f("div",Ae,[e("div",Ee,[s[4]||(s[4]=e("h3",{class:"text-lg font-semibold mb-2"},"Consultando datos del informe...",-1)),e("div",$e,[e("div",{style:ee({width:J.value+"%"}),class:"h-3 bg-primary transition-all"},null,4)]),e("div",Ce,"Progreso: "+v(b.value)+" / "+v(L)+" — "+v(J.value)+"%",1)])])):Z("",!0),e("div",Ve,[e("div",Ne,[e("div",Pe,[s[5]||(s[5]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-orange-400 inline-block"}),e("span",{class:"font-medium"},"Costos de compra")]),e("div",{class:"text-xs text-gray-500"},[m("Sumatoria de ("),e("em",null,"cantidad-de-entradas * costo-de-entrada-usd"),m(") de todo el inventario.")])],-1)),e("div",Be,[m(v(A.value.toFixed(2))+" ",1),e("span",Re,"("+v(B.value[0].toFixed(1))+"%)",1)])]),e("div",Ue,[s[6]||(s[6]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-blue-500 inline-block"}),e("span",{class:"font-medium"},"Inventario (valor)")]),e("div",{class:"text-xs text-gray-500"},[m("Sumatoria de ("),e("em",null,"costo-usd * cantidad-en-existencia"),m(") de todos los productos en el sistema.")])],-1)),e("div",ze,[m(v(E.value.toFixed(2))+" ",1),e("span",He,"("+v(B.value[1].toFixed(1))+"%)",1)])]),e("div",Oe,[s[7]||(s[7]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-green-500 inline-block"}),e("span",{class:"font-medium"},"Ventas (USD)")]),e("div",{class:"text-xs text-gray-500"},[m("Sumatoria de ("),e("em",null,"precio-usd-cobrado-de-venta * cantidad"),m(") de todas las ventas.")])],-1)),e("div",Ge,[m(v(D.value.toFixed(2))+" ",1),e("span",Le,"("+v(B.value[2].toFixed(1))+"%)",1)])]),e("div",Ye,[s[8]||(s[8]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-red-500 inline-block"}),e("span",{class:"font-medium"},"Salidas (Pérdidas)")]),e("div",{class:"text-xs text-gray-500"},[m("Sumatoria de ("),e("em",null,"cantidad * producto.costo_usd"),m(") de las salidas (pérdidas).")])],-1)),e("div",Je,[m(v(T.value.toFixed(2))+" ",1),e("span",qe,"("+v(B.value[3].toFixed(1))+"%)",1)])]),e("div",Ke,[s[9]||(s[9]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm bg-white border border-gray-300 inline-block"}),e("span",{class:"font-medium"},"Retiros (USD)")]),e("div",{class:"text-xs text-gray-500"},[m("Sumatoria convertida en USD: ("),e("em",null,"cantidad_retirada_cup / cambio_moneda"),m(") + "),e("em",null,"cantidad_retirada_usd"),m(".")])],-1)),e("div",Xe,v(C.value.toFixed(2)),1)]),e("div",Qe,[s[10]||(s[10]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm border border-gray-300 inline-block"}),e("span",{class:"font-medium"},"Costo Ventas (USD)")]),e("div",{class:"text-xs text-gray-500"},[m("Sumatoria de ("),e("em",null,"costo-venta * cantidad"),m(") de todas las ventas registradas.")])],-1)),e("div",We,v($.value.toFixed(2)),1)]),e("div",Ze,[s[11]||(s[11]=e("div",null,[e("div",{class:"flex items-center gap-3"},[e("span",{class:"w-4 h-4 rounded-sm border border-gray-300 inline-block"}),e("span",{class:"font-medium"},"Ganancia (Ventas - Costos - Retiros)")]),e("div",{class:"text-xs text-gray-500"},[m("Ganancia neta: "),e("em",null,"Ventas - Costo de ventas - Pérdidas - Retiros")])],-1)),e("div",et,v(ue.value.toFixed(2)),1)])])])])):(x(),f("div",tt,[s[14]||(s[14]=e("h4",{class:"text-lg font-medium"},"Informe B — Rango de fechas",-1)),e("div",st,[e("label",at,[s[12]||(s[12]=e("div",{class:"text-sm text-gray-600 mb-1"},"Fecha inicio",-1)),te(e("input",{type:"date","onUpdate:modelValue":s[1]||(s[1]=o=>M.value=o),class:"w-full px-3 py-2 border rounded"},null,512),[[se,M.value]])]),e("label",ot,[s[13]||(s[13]=e("div",{class:"text-sm text-gray-600 mb-1"},"Fecha fin",-1)),te(e("input",{type:"date","onUpdate:modelValue":s[2]||(s[2]=o=>j.value=o),class:"w-full px-3 py-2 border rounded"},null,512),[[se,j.value]])]),e("div",{class:"flex items-end"},[e("button",{onClick:ce,class:"px-4 py-2 bg-primary text-neutral rounded"},"Generar")])]),s[15]||(s[15]=e("div",{class:"text-xs text-gray-500"},"Valores iniciales: mes anterior (inicio=1, fin=último día).",-1)),e("div",nt,[U.value?(x(),f("div",lt,"Generando informe...")):N.value?(x(),f("div",rt,"Error: "+v(N.value),1)):h.value.length===0?(x(),f("div",it,"No hay ventas en el rango seleccionado.")):(x(),f("div",ct,[(x(),f("svg",dt,[e("polyline",{points:h.value.map((o,d)=>{const l=d/(h.value.length-1||1)*100,u=Math.min(...h.value.map(r=>r.value)),t=Math.max(...h.value.map(r=>r.value)),n=t===u?25:10+(1-(o.value-u)/(t-u))*30;return l+","+n}).join(" "),fill:"none",stroke:"#2563eb","stroke-width":"0.8","stroke-linejoin":"round","stroke-linecap":"round"},null,8,ut),e("g",null,[(x(!0),f(ae,null,oe(h.value,(o,d)=>(x(),f("circle",{key:o.day,cx:d/(h.value.length-1||1)*100,cy:(function(){const l=Math.min(...h.value.map(t=>t.value)),u=Math.max(...h.value.map(t=>t.value));return u===l?25:10+(1-(o.value-l)/(u-l))*30})(),r:"1.2",fill:"#2563eb"},null,8,mt))),128))])])),e("div",vt,[(x(!0),f(ae,null,oe(h.value,o=>(x(),f("div",{key:o.day,class:"px-2 py-1 bg-gray-50 rounded border text-xs"},v(o.day)+": "+v(o.value.toFixed(2)),1))),128))])]))])]))])])])]))}},yt=ve(ft,[["__scopeId","data-v-d25b3a0e"]]);export{yt as default};
