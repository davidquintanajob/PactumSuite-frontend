import{r as c,J as Q,R as Ie,x as C,y as S,z as e,E as K,G as M,H as N,K as Te,L as Pe,I as Y,A as P,O as Ne,n as ye,q as E,k as ve,B as j,F as Ae,D as X,o as Ue,Q as we,h as pe}from"./DLx_sSSf.js";import{N as De}from"./uqRIYar1.js";import{S as Oe}from"./tYk8DSAs.js";import{D as Be}from"./B1U57Od_.js";import{_ as ze}from"./DTo_Qbs3.js";import{_ as He}from"./DlY85phm.js";import{_ as _e}from"./BiJ7237f.js";import{u as W,w as $e}from"./3SA47z_C.js";import"./ETKJmL_A.js";const Le={class:"relative"},Ke={class:"relative"},Ge=["placeholder","disabled"],Re={class:"absolute right-3 top-2.5"},qe={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},Je={key:1,class:"animate-spin h-5 w-5 text-gray-400",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},We={key:0,class:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"},Ye=["onMousedown"],Qe=["innerHTML"],Xe={key:1},Ze={key:1,class:"px-4 py-2 text-sm text-gray-500"},me={__name:"SelectSearchAPI",props:{modelValue:{type:[String,Number,null],default:null},endpoint:{type:String,required:!0},method:{type:String,default:"POST"},searchKey:{type:String,required:!0},labelKey:{type:String,required:!0},valueKey:{type:String,required:!0},placeholder:{type:String,default:"Buscar..."},disabled:{type:Boolean,default:!1},directData:{type:Boolean,default:!1},labelFormat:{type:String,default:null},initialLabel:{type:String,default:""}},emits:["update:modelValue","entidad-seleccionada","producto-seleccionado"],setup(v,{emit:G}){const s=v,z=G,l=c(null),x=c(""),$=c(null),U=c(null),w=c(!1),h=c(!1),k=c(-1),b=c(null),f=c([]),D=ye(),Z=g=>g[s.valueKey],O=g=>{if(s.labelFormat){let V=s.labelFormat;return V=V.replace(/\{\{([^}]+)\}\}/g,(y,u)=>{const B=u.split(".");let H=g;for(const L of B)H=H==null?void 0:H[L];return H||""}),V}return g[s.labelKey]},R=async g=>{if(!g||g.trim()===""){f.value=[];return}const V=localStorage.getItem("token");if(!V){console.error("No hay token de autenticación");return}try{h.value=!0;const y={[s.searchKey]:g},u=await fetch(`${D.public.backendHost}${s.endpoint}`,{method:s.method,headers:{"Content-Type":"application/json",Authorization:V},body:s.method!=="GET"?JSON.stringify(y):void 0});if(u.status===401){console.error("Sesión expirada"),localStorage.removeItem("token"),localStorage.removeItem("user"),E("/");return}if(!u.ok)throw new Error(`Error en la búsqueda: ${u.status}`);const B=await u.json();s.directData?f.value=Array.isArray(B)?B:[]:f.value=B.data||[]}catch(y){console.error("Error al buscar:",y),f.value=[]}finally{h.value=!1}},q=()=>{if(b.value&&clearTimeout(b.value),x.value===""){$.value=null,U.value=null,z("update:modelValue",null),f.value=[];return}b.value=setTimeout(()=>{R(x.value)},1500)},de=()=>{w.value=!0,k.value=-1,x.value&&Ne(()=>{var g;(g=l.value)==null||g.select()})},ge=()=>{setTimeout(()=>{w.value=!1,k.value=-1},200)},ee=g=>{if(w.value)switch(g.key){case"ArrowDown":g.preventDefault(),k.value=Math.min(k.value+1,f.value.length-1);break;case"ArrowUp":g.preventDefault(),k.value=Math.max(k.value-1,-1);break;case"Enter":g.preventDefault(),k.value>=0&&f.value[k.value]&&J(f.value[k.value]);break;case"Escape":w.value=!1,k.value=-1;break}},J=g=>{$.value=Z(g),U.value=g;const V=O(g);s.labelFormat?x.value=V.split(`
`)[0]:x.value=V,w.value=!1,k.value=-1,z("update:modelValue",$.value),s.valueKey==="id_entidad"&&z("entidad-seleccionada",g),s.valueKey==="id_producto"&&z("producto-seleccionado",g)},ue=()=>{$.value=null,U.value=null,x.value="",w.value=!1,k.value=-1,f.value=[],z("update:modelValue",null),s.valueKey==="id_entidad"&&z("entidad-seleccionada",null),s.valueKey==="id_producto"&&z("producto-seleccionado",null),Ne(()=>{var g;(g=l.value)==null||g.focus()})};return Q(()=>s.modelValue,g=>{g===null||g===""?($.value=null,U.value=null,x.value=""):g&&!$.value&&($.value=g)},{immediate:!0}),Q(()=>s.initialLabel,g=>{g&&!x.value&&(x.value=g)},{immediate:!0}),Ie(()=>{b.value&&clearTimeout(b.value)}),(g,V)=>(S(),C("div",Le,[e("div",Ke,[M(e("input",{ref_key:"inputRef",ref:l,"onUpdate:modelValue":V[0]||(V[0]=y=>x.value=y),type:"text",placeholder:v.placeholder,disabled:v.disabled,class:"w-full px-4 py-2 pr-10 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onFocus:de,onBlur:ge,onInput:q,onKeydown:ee},null,40,Ge),[[N,x.value]]),e("div",Re,[h.value?(S(),C("svg",Je,[...V[2]||(V[2]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):(S(),C("svg",qe,[...V[1]||(V[1]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},null,-1)])]))])]),w.value&&(f.value.length>0||h.value)?(S(),C("div",We,[$.value!==null&&$.value!==""&&!h.value?(S(),C("div",{key:0,class:"px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 cursor-pointer border-b",onMousedown:ue}," Limpiar selección ",32)):K("",!0),(S(!0),C(Te,null,Pe(f.value,(y,u)=>(S(),C("div",{key:Z(y),class:Y(["px-4 py-2 text-sm hover:bg-gray-100 cursor-pointer",{"bg-primary text-white":u===k.value}]),onMousedown:B=>J(y)},[s.labelFormat?(S(),C("div",{key:0,innerHTML:O(y).replace(/\n/g,"<br>")},null,8,Qe)):(S(),C("div",Xe,P(O(y)),1))],42,Ye))),128)),!h.value&&f.value.length===0&&x.value?(S(),C("div",Ze," No se encontraron resultados ")):K("",!0)])):K("",!0)]))}},et={key:0,class:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"},tt={key:0,class:"fixed top-6 left-1/2 transform -translate-x-1/2 z-[9999] w-full max-w-md px-4 pointer-events-none"},ot={class:"bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto"},at={class:"flex justify-between items-center mb-6"},rt={class:"text-2xl font-bold text-gray-800"},nt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},it={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"},lt={key:0},st={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"},dt=["readonly","disabled"],ut=["readonly","disabled"],ct={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"},vt=["readonly","disabled"],pt=["readonly","disabled"],mt={class:"mt-4"},gt={class:"relative flex w-full"},bt=["disabled"],ft=["disabled"],yt={key:0,class:"mt-4"},xt=["onUpdate:modelValue"],ht=["onUpdate:modelValue","onBlur","disabled"],wt=["onUpdate:modelValue","onBlur","readonly","disabled"],kt=["value"],_t=["onClick","disabled"],Ct=["disabled"],St={class:"mt-4 p-4 bg-gray-100 rounded-lg"},Ft={key:1,class:"mt-4"},Vt=["onUpdate:modelValue","disabled"],Et=["onUpdate:modelValue","disabled"],$t=["onUpdate:modelValue","onBlur","disabled"],Tt=["onUpdate:modelValue","onBlur","disabled"],Pt=["value"],jt=["onClick","disabled"],Mt=["disabled"],Nt={class:"mt-4 p-4 bg-gray-100 rounded-lg"},zt={key:2,class:"flex justify-end space-x-4 mt-6"},It=["disabled"],At=["disabled"],Ut={key:0,class:"flex items-center"},Dt={key:1},Ot={key:0,class:"text-red-600 text-sm mt-2"},Bt={__name:"FacturaModal",props:{modelValue:{type:Boolean,required:!0},factura:{type:Object,default:()=>({})},isEditing:{type:Boolean,default:!1},isViewing:{type:Boolean,default:!1},contratos:{type:Array,default:()=>[]},entidades:{type:Array,default:()=>[]},trabajadores:{type:Array,default:()=>[]},usuarios:{type:Array,default:()=>[]}},emits:["update:modelValue","submit"],setup(v,{emit:G}){const s=v,z=G,l=c({id_entidad:"",id_contrato:"",id_usuario:"",id_trabajador_autorizado:"",num_consecutivo:"",fecha:"",estado:"",nota:"",cargoAdicional:""}),x=c("productos");Q(()=>s.factura,o=>{o&&o.tipoFactura?x.value=o.tipoFactura:x.value="productos"});function $(o){s.isViewing||s.isLoading||(x.value=o,l.value.tipoFactura=o)}const U=c([{label:"Facturado",value:"Facturado"},{label:"No Facturado",value:"No Facturado"},{label:"Cancelado",value:"Cancelado"}]),w=c([{descripcion:"",unidadMedida:"",cantidad:0,importe:0}]),h=c([{id_producto:"",nombre:"",unidadMedida:"",cantidad:0,precio:0}]),k=c(""),b=c(!1),f=c(null),D=c([]),Z=c(null),O=c(null),R=c(null),q=ve(()=>D.value.find(o=>o.id_contrato===l.value.id_contrato)),de=ve(()=>q.value?q.value.ClienteOProveedor!=="Cliente":!1);async function ge(){const o=localStorage.getItem("token");if(!o){E("/");return}try{const t=ye(),r=new Date().getFullYear(),p=await fetch(`${t.public.backendHost}/Factura/nextConsecutivo/${r}`,{method:"GET",headers:{Authorization:o}});if(p.status===401||p.status===403){errorBanner.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(p.ok){const d=await p.json();d.data&&d.data.nextConsecutivo&&(l.value.num_consecutivo=d.data.nextConsecutivo,localStorage.setItem("num_consecutivo_guardado",d.data.nextConsecutivo))}else console.error("Error al obtener el siguiente consecutivo")}catch(t){console.error("Error al obtener el siguiente consecutivo:",t)}}Q(()=>s.modelValue,async o=>{o&&(!s.isEditing&&!s.isViewing?await ge():s.isViewing&&await ge())}),Q(()=>s.factura,async o=>{var t,r;if(o&&Object.keys(o).length>0){if(l.value={id_entidad:((t=o.contrato)==null?void 0:t.id_entidad)||"",id_contrato:o.id_contrato||"",id_usuario:o.id_usuario||"",id_trabajador_autorizado:o.id_trabajador_autorizado||"",num_consecutivo:o.num_consecutivo||"",fecha:o.fecha?o.fecha.substring(0,10):"",estado:o.estado||"",nota:o.nota||"",cargoAdicional:o.cargoAdicional||""},o.servicio&&o.servicio.length>0?(x.value="servicios",w.value=[...o.servicio],l.value.services=[...o.servicio],h.value=[{id_producto:"",nombre:"",unidadMedida:"",cantidad:0,precio:0}],l.value.products=[]):(x.value="productos",o.productos&&o.productos.length>0?(h.value=o.productos.map(p=>{var d,oe;return{id_producto:p.id_producto,nombre:p.nombre,unidadMedida:p.unidadMedida,cantidad:((d=p.factura_producto)==null?void 0:d.cantidad)||0,precio:((oe=p.factura_producto)==null?void 0:oe.precioVenta)||p.precio}}),l.value.products=[...o.productos]):(h.value=[{id_producto:"",nombre:"",unidadMedida:"",cantidad:0,precio:0}],l.value.products=[]),w.value=[{descripcion:"",unidadMedida:"",cantidad:0,importe:0}],l.value.services=[]),(r=o.contrato)!=null&&r.id_entidad&&await y(o.contrato.id_entidad),(s.isViewing||s.isEditing)&&(o.id_usuario&&await u(o.id_usuario),o.id_trabajador_autorizado&&await B(o.id_trabajador_autorizado)),!s.isViewing){const p=D.value.find(d=>d.id_contrato===l.value.id_contrato);if(p&&p.ClienteOProveedor==="Cliente"){const d=localStorage.getItem("num_consecutivo_guardado");d&&(l.value.num_consecutivo=d,console.log("Carga inicial (crear/editar): Número consecutivo establecido a:",d))}}}else l.value={id_entidad:"",id_contrato:"",id_usuario:"",id_trabajador_autorizado:"",num_consecutivo:"",fecha:"",estado:"",nota:"",cargoAdicional:""},D.value=[],Z.value=null,O.value=null,R.value=null,h.value=[{id_producto:"",nombre:"",unidadMedida:"",cantidad:0,precio:0}],w.value=[{descripcion:"",unidadMedida:"",cantidad:0,importe:0}]},{immediate:!0}),Q(()=>l.value.id_contrato,o=>{if(!s.isViewing&&o){const t=D.value.find(r=>r.id_contrato===o);if(t&&t.ClienteOProveedor==="Cliente"){const r=localStorage.getItem("num_consecutivo_guardado");r&&(l.value.num_consecutivo=r,console.log("Selección de contrato (crear/editar): Número consecutivo establecido a:",r))}}}),Q(()=>h.value,o=>{if(o.length>0&&!s.isViewing){const t=o[o.length-1];t.id_producto&&t.unidadMedida&&t.cantidad>0&&t.precio>0&&h.value.push({id_producto:"",nombre:"",unidadMedida:"",cantidad:0,precio:0})}},{deep:!0}),Q(()=>w.value,o=>{if(o.length>0&&!s.isViewing){const t=o[o.length-1];t.descripcion&&t.unidadMedida&&t.cantidad>0&&t.importe>0&&w.value.push({descripcion:"",unidadMedida:"",cantidad:0,importe:0})}},{deep:!0});const ee=async()=>{if(k.value="",x.value==="productos"?(l.value.products=h.value.filter(o=>o.id_producto&&o.cantidad>0),delete l.value.services):(l.value.services=w.value.filter(o=>o.descripcion&&o.unidadMedida&&o.cantidad>0&&o.importe>0),delete l.value.products),!s.isEditing&&!s.isViewing){const o=localStorage.getItem("usuario");if(o)try{const t=JSON.parse(o);t&&t.id_usuario&&(l.value.id_usuario=t.id_usuario)}catch(t){console.error("Error al parsear datos de usuario del localStorage:",t)}}if(!l.value.id_contrato){k.value="Debe seleccionar un Contrato.";return}if(!l.value.id_usuario){k.value="Debe seleccionar un Usuario.";return}if(!l.value.num_consecutivo){k.value="Debe ingresar el Número Consecutivo.";return}if(!l.value.fecha){k.value="Debe ingresar la Fecha.";return}if(!l.value.estado){k.value="Debe seleccionar un Estado.";return}b.value=!0,f.value={title:s.isEditing?"Guardando Factura":"Creando Factura",description:"Comunicando con el servidor, espere por favor...",type:"warning"};try{z("submit",{...l.value})}catch(o){console.error("Error en handleSubmit:",o)}finally{setTimeout(()=>{b.value=!1,f.value=null},500)}},J=ve(()=>s.factura&&s.factura.contrato&&s.factura.contrato.entidad&&s.factura.contrato.entidad.nombre||""),ue=ve(()=>O.value?O.value.nombre||"":s.factura&&s.factura.usuario&&s.factura.usuario.nombre||""),g=ve(()=>R.value?R.value.nombre||"":s.factura&&s.factura.trabajador_autorizado&&s.factura.trabajador_autorizado.nombre||""),V=async o=>{o&&o.id_entidad?(l.value.id_contrato="",await y(o.id_entidad)):(D.value=[],l.value.id_contrato="")};async function y(o){if(!o){D.value=[];return}const t=localStorage.getItem("token");if(!t){E("/");return}f.value={title:"Cargando Datos de la Base de Datos",description:"Obteniendo contratos de la base de datos...",type:"info"};try{const r=ye(),p=await fetch(`${r.public.backendHost}/entidad/${o}`,{method:"GET",headers:{Authorization:t}});if(p.status===401||p.status===403){errorBanner.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(p.ok){const d=await p.json();Z.value=d;const oe=(d==null?void 0:d.contratos)||[];D.value=oe.map(fe=>{var n;return{...fe,displayLabel:`${fe.num_consecutivo} - ${((n=fe.tipoContrato)==null?void 0:n.nombre)||""} - ${fe.ClienteOProveedor||""}`}})}else console.error("Error en la respuesta:",p.status),D.value=[]}catch(r){console.error("Error al cargar contratos:",r),D.value=[]}finally{setTimeout(()=>{f.value=null},3e3)}}async function u(o){if(!o)return;const t=localStorage.getItem("token");if(!t){E("/");return}try{const r=ye(),p=await fetch(`${r.public.backendHost}/Usuario/${o}`,{method:"GET",headers:{Authorization:t}});if(p.status===401||p.status===403){errorBanner.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(p.ok){const d=await p.json();O.value={nombre:d.nombre}}else console.error("Error al cargar usuario:",p.status)}catch(r){console.error("Error al cargar usuario:",r)}}async function B(o){if(!o)return;const t=localStorage.getItem("token");if(!t){E("/");return}try{const r=ye(),p=await fetch(`${r.public.backendHost}/trabajadorAutorizado/${o}`,{method:"GET",headers:{Authorization:t}});if(p.status===401||p.status===403){errorBanner.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(p.ok){const d=await p.json();R.value={nombre:d.nombre}}else console.error("Error al cargar trabajador:",p.status)}catch(r){console.error("Error al cargar trabajador:",r)}}function H(){w.value.push({descripcion:"",unidadMedida:"",cantidad:0,importe:0})}function L(o){w.value.length>1&&w.value.splice(o,1)}function Ce(){h.value.push({id_producto:"",nombre:"",unidadMedida:"",cantidad:0,precio:0})}function te(o,t){if(t>=0&&t<h.value.length)if(o){let r=0,p=o.precio||0;if(s.factura&&s.factura.id_factura&&o.facturaProductos){const d=o.facturaProductos.find(oe=>oe.id_factura===s.factura.id_factura);d&&(r=Number(d.cantidad)||0,p=Number(d.precioVenta)||o.precio||0)}h.value[t]={...h.value[t],id_producto:o.id_producto,nombre:o.nombre,unidadMedida:o.unidadMedida||"",cantidad:r,precio:p}}else h.value[t]={...h.value[t],id_producto:"",nombre:"",unidadMedida:"",cantidad:0,precio:0}}function Se(o){h.value.length>1&&h.value.splice(o,1)}const ke=o=>{o.cantidad!==void 0&&o.cantidad!==null&&(o.cantidad=Number(o.cantidad).toFixed(2))},ce=o=>{o.precio!==void 0&&o.precio!==null&&(o.precio=Number(o.precio).toFixed(2))},Fe=o=>{o.importe!==void 0&&o.importe!==null&&(o.importe=Number(o.importe).toFixed(2))};function be(o){const t=Number(o.cantidad)||0,r=Number(o.precio)||0,p=Number(o.importe)||0,d=o.precio!==void 0?r:p;return(t*d).toFixed(2)}const Ve=ve(()=>(h.value.reduce((t,r)=>t+Number(r.cantidad)*Number(r.precio),0)+(Number(l.value.cargoAdicional)||0)).toFixed(2)),Ee=ve(()=>(w.value.reduce((t,r)=>t+Number(r.cantidad)*Number(r.importe),0)+(Number(l.value.cargoAdicional)||0)).toFixed(2));return(o,t)=>v.modelValue?(S(),C("div",et,[f.value?(S(),C("div",tt,[j(ze,{title:f.value.title,description:f.value.description,type:f.value.type,onClose:t[0]||(t[0]=r=>f.value=null),class:"pointer-events-auto"},null,8,["title","description","type"])])):K("",!0),e("div",ot,[e("div",at,[e("h2",rt,P(v.isViewing?"Detalles de Factura":v.isEditing?"Editar Factura":"Nueva Factura"),1),e("button",{onClick:t[1]||(t[1]=r=>o.$emit("update:modelValue",!1)),class:"text-gray-500 hover:text-gray-700"},[...t[14]||(t[14]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("form",{onSubmit:Ae(ee,["prevent"]),class:"space-y-4"},[e("div",nt,[e("div",null,[t[15]||(t[15]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Entidad",-1)),j(me,{modelValue:l.value.id_entidad,"onUpdate:modelValue":t[2]||(t[2]=r=>l.value.id_entidad=r),endpoint:"/entidad/filter/1/10",method:"POST","search-key":"nombre","label-key":"nombre","value-key":"id_entidad",placeholder:"Buscar entidad por nombre...",disabled:v.isViewing||b.value,"initial-label":J.value,onEntidadSeleccionada:V},null,8,["modelValue","disabled","initial-label"])]),e("div",null,[t[16]||(t[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Contrato",-1)),j(_e,{modelValue:l.value.id_contrato,"onUpdate:modelValue":t[3]||(t[3]=r=>l.value.id_contrato=r),options:D.value,labelKey:"displayLabel",valueKey:"id_contrato",disabled:v.isViewing||b.value||!l.value.id_entidad,class:Y({"opacity-50":!l.value.id_entidad}),placeholder:"Seleccione primero una entidad..."},null,8,["modelValue","options","disabled","class"])])]),e("div",it,[v.isViewing||v.isEditing?(S(),C("div",lt,[t[17]||(t[17]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Usuario",-1)),j(me,{modelValue:l.value.id_usuario,"onUpdate:modelValue":t[4]||(t[4]=r=>l.value.id_usuario=r),endpoint:"/Usuario/filterUsers",method:"POST","search-key":"nombre_usuario","label-key":"nombre_usuario","value-key":"id_usuario",placeholder:"Buscar usuario por nombre...",disabled:!0,"initial-label":ue.value,"direct-data":!0,class:Y({"opacity-50":v.isViewing||v.isEditing})},null,8,["modelValue","initial-label","class"])])):K("",!0),e("div",null,[t[18]||(t[18]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Trabajador Autorizado",-1)),j(me,{modelValue:l.value.id_trabajador_autorizado,"onUpdate:modelValue":t[5]||(t[5]=r=>l.value.id_trabajador_autorizado=r),endpoint:"/trabajadorAutorizado/filter/1/10",method:"POST","search-key":"nombre","label-key":"nombre","value-key":"id_trabajador",placeholder:"Buscar trabajador por nombre...",disabled:v.isViewing||b.value,"initial-label":g.value},null,8,["modelValue","disabled","initial-label"])])]),e("div",st,[e("div",null,[t[19]||(t[19]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Número Consecutivo",-1)),M(e("input",{"onUpdate:modelValue":t[6]||(t[6]=r=>l.value.num_consecutivo=r),type:"number",readonly:v.isViewing||!de.value,disabled:b.value,class:Y(["w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500",{"bg-gray-100 text-gray-500":v.isViewing||!de.value}]),required:""},null,10,dt),[[N,l.value.num_consecutivo]])]),e("div",null,[t[20]||(t[20]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha",-1)),M(e("input",{"onUpdate:modelValue":t[7]||(t[7]=r=>l.value.fecha=r),type:"date",readonly:v.isViewing,disabled:v.isViewing||b.value,class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500",required:""},null,8,ut),[[N,l.value.fecha]])])]),e("div",ct,[e("div",null,[t[21]||(t[21]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Estado",-1)),j(_e,{modelValue:l.value.estado,"onUpdate:modelValue":t[8]||(t[8]=r=>l.value.estado=r),options:U.value,labelKey:"label",valueKey:"value",disabled:v.isViewing||b.value,placeholder:"Selecciona un estado"},null,8,["modelValue","options","disabled"])]),e("div",null,[t[22]||(t[22]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Cargo Adicional",-1)),M(e("input",{"onUpdate:modelValue":t[9]||(t[9]=r=>l.value.cargoAdicional=r),type:"number",readonly:v.isViewing,disabled:v.isViewing||b.value,class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Ingrese cargo adicional (opcional)"},null,8,vt),[[N,l.value.cargoAdicional]])])]),e("div",null,[t[23]||(t[23]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Nota",-1)),M(e("textarea",{"onUpdate:modelValue":t[10]||(t[10]=r=>l.value.nota=r),readonly:v.isViewing,disabled:v.isViewing||b.value,class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500",rows:"2",placeholder:"Ingrese una nota opcional"},null,8,pt),[[N,l.value.nota]])]),e("div",mt,[t[24]||(t[24]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2 text-center"},"Tipo de Factura",-1)),e("div",gt,[e("div",{class:Y(["absolute top-0 left-0 w-1/2 h-full bg-primary rounded-lg transition-transform duration-300",x.value==="productos"?"transform translate-x-0":"transform translate-x-full"])},null,2),e("button",{type:"button",onClick:t[11]||(t[11]=r=>$("productos")),class:Y(["relative flex-1 px-4 py-2 rounded-lg font-medium transition-all duration-300 z-10",x.value==="productos"?"text-neutral bg-transparent":"text-dark bg-secondary"]),disabled:v.isViewing||b.value}," Venta Productos ",10,bt),e("button",{type:"button",onClick:t[12]||(t[12]=r=>$("servicios")),class:Y(["relative flex-1 px-4 py-2 rounded-lg font-medium transition-all duration-300 z-10",x.value==="servicios"?"text-neutral bg-transparent":"text-dark bg-secondary"]),disabled:v.isViewing||b.value}," Prestación de Servicios ",10,ft)])]),x.value==="productos"?(S(),C("div",yt,[t[27]||(t[27]=e("h3",{class:"text-lg font-semibold mb-2"},"Productos",-1)),t[28]||(t[28]=e("div",{class:"grid grid-cols-1 md:grid-cols-7 gap-4 mb-2 font-semibold text-gray-700"},[e("span",{class:"col-span-2"},"Producto"),e("span",null,"Uni/Medida"),e("span",null,"Cantidad"),e("span",null,"Precio"),e("span",null,"Total"),e("span",null,"Acción")],-1)),(S(!0),C(Te,null,Pe(h.value,(r,p)=>(S(),C("div",{key:p,class:"grid grid-cols-1 md:grid-cols-7 gap-4 mb-2"},[j(me,{modelValue:r.id_producto,"onUpdate:modelValue":d=>r.id_producto=d,endpoint:"/producto/filterProductos/1/10",method:"POST","search-key":"nombre","label-key":"nombre","value-key":"id_producto",placeholder:"Buscar producto por nombre...",disabled:v.isViewing||b.value,"initial-label":r.nombre||"",onProductoSeleccionado:d=>te(d,p),class:"col-span-2"},null,8,["modelValue","onUpdate:modelValue","disabled","initial-label","onProductoSeleccionado"]),M(e("input",{"onUpdate:modelValue":d=>r.unidadMedida=d,type:"text",placeholder:"Uni/Medida",readonly:"",class:"px-4 py-2 border-2 border-gray-400 rounded-lg opacity-50"},null,8,xt),[[N,r.unidadMedida]]),M(e("input",{"onUpdate:modelValue":d=>r.cantidad=d,onBlur:d=>ke(r),type:"number",step:"0.01",placeholder:"Cantidad",class:"px-4 py-2 border-2 border-gray-400 rounded-lg",disabled:v.isViewing||b.value},null,40,ht),[[N,r.cantidad,void 0,{number:!0}]]),M(e("input",{"onUpdate:modelValue":d=>r.precio=d,onBlur:d=>ce(r),type:"number",step:"0.01",placeholder:"Precio",readonly:!v.isEditing||v.isViewing,disabled:v.isViewing||b.value,class:Y(["px-4 py-2 border-2 border-gray-400 rounded-lg",{"opacity-50":!v.isEditing||v.isViewing}])},null,42,wt),[[N,r.precio,void 0,{number:!0}]]),e("input",{value:be(r),type:"text",readonly:"",class:"px-4 py-2 border-2 border-blue-400 bg-blue-50 rounded-lg font-bold text-blue-800"},null,8,kt),e("button",{onClick:d=>Se(p),type:"button",class:"px-4 py-2 bg-red-500 text-white rounded-lg flex items-center",disabled:v.isViewing||b.value},[...t[25]||(t[25]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1),X(" Eliminar ",-1)])],8,_t)]))),128)),e("button",{onClick:Ce,type:"button",class:"px-4 py-2 bg-purple-500 text-white rounded-lg mt-2 flex items-center",disabled:v.isViewing||b.value},[...t[26]||(t[26]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})],-1),X(" Producto ",-1)])],8,Ct),e("div",St,[e("strong",null,"Importe Total Productos: "+P(Ve.value),1)])])):K("",!0),x.value==="servicios"?(S(),C("div",Ft,[t[31]||(t[31]=e("h3",{class:"text-lg font-semibold mb-2"},"Servicios",-1)),t[32]||(t[32]=e("div",{class:"grid grid-cols-1 md:grid-cols-7 gap-4 mb-2 font-semibold text-gray-700"},[e("span",{class:"col-span-2"},"Descripción"),e("span",null,"Uni/Medida"),e("span",null,"Cantidad"),e("span",null,"Importe"),e("span",null,"Total"),e("span",null,"Acción")],-1)),(S(!0),C(Te,null,Pe(w.value,(r,p)=>(S(),C("div",{key:r.id_servicio,class:"grid grid-cols-1 md:grid-cols-7 gap-4 mb-2"},[M(e("input",{"onUpdate:modelValue":d=>r.descripcion=d,type:"text",placeholder:"Descripción",class:"col-span-2 px-4 py-2 border-2 border-gray-400 rounded-lg",disabled:v.isViewing||b.value},null,8,Vt),[[N,r.descripcion]]),M(e("input",{"onUpdate:modelValue":d=>r.unidadMedida=d,type:"text",placeholder:"Uni/Medida",class:"px-4 py-2 border-2 border-gray-400 rounded-lg",disabled:v.isViewing||b.value},null,8,Et),[[N,r.unidadMedida]]),M(e("input",{"onUpdate:modelValue":d=>r.cantidad=d,onBlur:d=>ke(r),type:"number",step:"0.01",placeholder:"Cantidad",class:"px-4 py-2 border-2 border-gray-400 rounded-lg",disabled:v.isViewing||b.value},null,40,$t),[[N,r.cantidad,void 0,{number:!0}]]),M(e("input",{"onUpdate:modelValue":d=>r.importe=d,onBlur:d=>Fe(r),type:"number",step:"0.01",placeholder:"Importe",class:"px-4 py-2 border-2 border-gray-400 rounded-lg",disabled:v.isViewing||b.value},null,40,Tt),[[N,r.importe,void 0,{number:!0}]]),e("input",{value:be(r),type:"text",readonly:"",class:"px-4 py-2 border-2 border-blue-400 bg-blue-50 rounded-lg font-bold text-blue-800"},null,8,Pt),e("button",{onClick:d=>L(p),type:"button",class:"px-4 py-2 bg-red-500 text-white rounded-lg flex items-center",disabled:v.isViewing||b.value},[...t[29]||(t[29]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})],-1),X(" Eliminar ",-1)])],8,jt)]))),128)),e("button",{onClick:H,type:"button",class:"px-4 py-2 bg-purple-500 text-white rounded-lg mt-2 flex items-center",disabled:v.isViewing||b.value},[...t[30]||(t[30]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})],-1),X(" Servicio ",-1)])],8,Mt),e("div",Nt,[e("strong",null,"Importe Total Servicios: "+P(Ee.value),1)])])):K("",!0),v.isViewing?K("",!0):(S(),C("div",zt,[e("button",{type:"button",onClick:t[13]||(t[13]=r=>o.$emit("update:modelValue",!1)),class:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500",disabled:b.value}," Cancelar ",8,It),e("button",{type:"submit",class:"px-4 py-2 text-neutral bg-primary rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed",disabled:b.value},[b.value?(S(),C("span",Ut,[t[33]||(t[33]=e("svg",{class:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),X(" "+P(v.isEditing?"Guardando...":"Creando..."),1)])):(S(),C("span",Dt,P(v.isEditing?"Guardar Cambios":"Crear Factura"),1))],8,At)]))],32),k.value?(S(),C("div",Ot,P(k.value),1)):K("",!0)])])):K("",!0)}},Ht={class:"min-h-screen bg-gradient-to-br via-secondary/40 from-accent/30 to-neutral"},Lt={key:0,class:"fixed top-6 left-1/2 transform -translate-x-1/2 z-[9999] w-full max-w-md px-4 pointer-events-none"},Kt={key:1,class:"fixed top-24 left-1/2 transform -translate-x-1/2 z-[10000] w-full max-w-md px-4 pointer-events-auto"},Gt={class:"w-[95%] mx-auto px-4 py-4 md:py-4 mt-20 md:mt-0"},Rt={class:"bg-white rounded-lg shadow-md p-4"},qt={class:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"},Jt={class:"w-full"},Wt={class:"w-full"},Yt={class:"w-full"},Qt={class:"w-full"},Xt={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"},Zt={class:"w-full"},eo={class:"w-full"},to={class:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"},oo={class:"w-full"},ao={class:"w-full"},ro={class:"w-full"},no={class:"w-full"},io={class:"w-[95%] mx-auto px-4 py-4"},lo={class:"mt-6 bg-white rounded-lg shadow-md p-4 w-[95%] mx-auto"},so={class:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center"},uo={class:"bg-orange-100 text-orange-800 rounded p-3"},co={class:"text-lg font-bold"},vo={class:"text-lg font-bold"},po={class:"text-lg font-bold"},mo={class:"bg-blue-100 text-blue-800 rounded p-3"},go={class:"text-lg font-bold"},bo={class:"text-lg font-bold"},fo={class:"text-lg font-bold"},yo={class:"bg-orange-100 text-orange-800 rounded p-3"},xo={class:"text-lg font-bold"},ho={class:"text-lg font-bold"},wo={class:"text-lg font-bold"},ko={class:"bg-blue-100 text-blue-800 rounded p-3"},_o={class:"text-lg font-bold"},Co={class:"text-lg font-bold"},So={class:"text-lg font-bold"},zo={__name:"facturas",setup(v){const G=c(""),s=c(""),z=c(""),l=c(""),x=c(""),$=c(""),U=c(""),w=c(""),h=c(""),k=c(""),b=c([{label:"Todos",value:null},{label:"Facturado",value:"Facturado"},{label:"No Facturado",value:"No Facturado"},{label:"Cancelado",value:"Cancelado"}]),f=c([]),D=c(null),Z=c(null),O=c(!1),R=c({}),q=c(!1),de=c(!1),ge=[{key:"num_consecutivo",label:"Num. Consecutivo"},{key:"fecha",label:"Fecha",cellRenderer:n=>n?`<span class="px-2 py-1 rounded text-sm">${n.substring(0,10)}</span>`:""},{key:"estado",label:"Estado",cellRenderer:n=>{if(!n)return"";let a="";return n==="Facturado"?a="bg-green-100 text-green-800":n==="No Facturado"?a="bg-yellow-100 text-yellow-800":n==="Cancelado"&&(a="bg-red-100 text-red-800"),`<span class="px-2 py-1 rounded-full text-sm font-medium ${a}">${n}</span>`}},{key:"contrato.ClienteOProveedor",label:"Cliente o Proveedor",cellRenderer:n=>n?`<span class="px-2 py-1 rounded-full text-sm font-medium ${n==="Cliente"?"bg-blue-100 text-blue-800":"bg-orange-100 text-orange-800"}">${n}</span>`:""},{key:"contrato.num_consecutivo",label:"Contrato"},{key:"contrato.tipoContrato.nombre",label:"Tipo Contrato"},{key:"suma_general",label:"Importe",cellRenderer:n=>{if(n==null||n==="")return"";const a=parseFloat(n);return isNaN(a)?n:`<span class="px-2 py-1 rounded text-sm">${a.toFixed(2)}</span>`}},{key:"contrato.entidad.nombre",label:"Entidad"},{key:"usuario.nombre",label:"Creado por"}],ee=c(1),J=c(0),ue=c(!1),g=c(10),V=c([]),y=c({}),u=c(null),B=c(!1),H=c(null),L=ye(),Ce=[{name:"Editar",icon:{render(){return pe("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[pe("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 7.5-7.5z"})])}},handler:n=>be(n,"editar"),iconOnly:!1,buttonClass:"px-3 py-1 bg-accent text-neutral rounded-md hover:bg-accent/90"},{name:"Eliminar",icon:{render(){return pe("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[pe("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 19a2 2 0 002 2h8a2 2 0 002-2V7H6v12z"}),pe("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7V5a2 2 0 00-2-2H7a2 2 0 00-2 2v2"})])}},handler:n=>Ee(n),iconOnly:!1,buttonClass:"px-3 py-1 bg-danger text-neutral rounded-md hover:bg-danger/90"}],te=async()=>{try{ue.value=!0,await ce(1)}catch(n){console.error("Error al buscar facturas:",n)}finally{ue.value=!1}};function Se(n){ce(n)}function ke(n){be(n,"ver")}async function ce(n=1){var i,_;const a=localStorage.getItem("token");if(!a){E("/");return}try{const F={id_contrato:U.value||0,id_entidad:w.value||0,consecutivoEntidad:G.value||void 0,organismoEntidad:s.value||void 0,num_consecutivo:z.value||0,fecha_desde:l.value||void 0,fecha_hasta:x.value||void 0,estado:$.value||void 0,id_trabajador_autorizado:h.value||0,id_usuario:k.value||0},T=await fetch(`${L.public.backendHost}/Factura/filterFacturas/${n}/${g.value}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:a},body:JSON.stringify(F)});if(T.status===401){u.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(T.status===403){u.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"};return}const I=await T.json();V.value=I.data||[],J.value=((i=I.pagination)==null?void 0:i.total)||0,ee.value=((_=I.pagination)==null?void 0:_.currentPage)||1,y.value=I.pagination}catch{u.value={title:"Error",description:"No se pudieron cargar las facturas",type:"error"}}}async function Fe(n){if(!n){f.value=[];return}const a=localStorage.getItem("token");if(!a){E("/");return}try{const i=await fetch(`${L.public.backendHost}/entidad/${n}`,{method:"GET",headers:{Authorization:a}});if(i.status===401||i.status===403){u.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(i.ok){const _=await i.json();D.value=_;const F=(_==null?void 0:_.contratos)||[];f.value=F.map(T=>{var I;return{...T,displayLabel:`${T.num_consecutivo} - ${((I=T.tipoContrato)==null?void 0:I.nombre)||""} - ${T.ClienteOProveedor||""}`}})}else console.error("Error en la respuesta:",i.status),f.value=[]}catch(i){console.error("Error al cargar contratos:",i),f.value=[]}}function be(n,a){R.value=n?{...n}:{},q.value=a==="editar",de.value=a==="ver",O.value=!0}function Ve(){be({},"crear")}function Ee(n){H.value=n,B.value=!0}async function o(){if(!H.value)return;const n=localStorage.getItem("token");if(!n){E("/");return}try{const a=await fetch(`${L.public.backendHost}/Factura/deleteFactura/${H.value.id_factura}`,{method:"DELETE",headers:{Authorization:n}});if(a.status===401){u.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(a.status===403){u.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"};return}if(!a.ok){let i="No se pudo eliminar la factura";try{const _=await a.json();_&&_.message&&(i=_.message)}catch{}throw new Error(i)}u.value={title:"Éxito",description:"Factura eliminada correctamente",type:"success"},ce(ee.value)}catch(a){u.value={title:"Error",description:a.message,type:"error"}}finally{B.value=!1,H.value=null}}const t=async n=>{const a=localStorage.getItem("token");if(!a){E("/");return}try{const i=q.value?`${L.public.backendHost}/Factura/updateFactura/${R.value.id_factura}`:`${L.public.backendHost}/Factura/createFactura`,_=await fetch(i,{method:q.value?"PUT":"POST",headers:{"Content-Type":"application/json",Authorization:a,Accept:"application/json"},body:JSON.stringify(n)});if(_.status===401){u.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(_.status===403){u.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción.",type:"error"};return}if(_.status===400||_.status===500){const F=await _.json();F.errors&&Array.isArray(F.errors)?u.value={title:`Errores de validación: ${_.status}`,description:F.errors.join(`
`),type:"error"}:F.error?u.value={title:`Error: ${_.status}`,description:F.error,type:"error"}:u.value={title:`Error: ${_.status}`,description:JSON.stringify(F),type:"error"};return}if(!_.ok){let F="No se pudo guardar la factura";try{const T=await _.json();T&&T.message&&(F=T.message)}catch{}throw new Error(F)}u.value={title:"Éxito",description:q.value?"Factura actualizada correctamente":"Factura creada correctamente",type:"success"},O.value=!1,ce(ee.value)}catch(i){u.value={title:"Error",description:i.message,type:"error"}}};async function r(){u.value={title:"Consultando datos",description:"Se están consultando los datos, la descarga comenzará en breve.",type:"info"};try{const n=localStorage.getItem("token"),a={id_contrato:U.value||0,id_entidad:w.value||0,consecutivoEntidad:G.value||void 0,organismoEntidad:s.value||void 0,num_consecutivo:z.value||0,fecha_desde:l.value||void 0,fecha_hasta:x.value||void 0,estado:$.value||void 0,id_trabajador_autorizado:h.value||0,id_usuario:k.value||0},i=await fetch(`${L.public.backendHost}/Factura/filterFacturas/1/${J.value}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:n,Accept:"application/json"},body:JSON.stringify(a)});if(i.status===401){u.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(i.status===403){u.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"};return}if(!i.ok){const m=await i.json();u.value={title:"Error al consultar datos",description:m.error||"Ocurrió un error al consultar los datos.",type:"error"};return}const F=(await i.json()).data.map(m=>{var A,ae,re,ne,ie,le,se;return{"Num. Consecutivo":m.num_consecutivo,Fecha:m.fecha?m.fecha.substring(0,10):"",Estado:m.estado,"Creado por":((A=m.usuario)==null?void 0:A.nombre)||"","Cliente o Proveedor":((ae=m.contrato)==null?void 0:ae.ClienteOProveedor)||"",Contrato:((re=m.contrato)==null?void 0:re.num_consecutivo)||"","Tipo Contrato":((ie=(ne=m.contrato)==null?void 0:ne.tipoContrato)==null?void 0:ie.nombre)||"",Importe:m.suma_general?parseFloat(m.suma_general).toFixed(2):"",Entidad:((se=(le=m.contrato)==null?void 0:le.entidad)==null?void 0:se.nombre)||""}}),T=W.json_to_sheet(F),I=W.book_new();W.book_append_sheet(I,T,"Facturas");const xe=new Date().toISOString().split("T")[0];$e(I,`facturas_${xe}.xlsx`),u.value=null}catch(n){console.error("Error al exportar a Excel:",n),u.value={title:"Error",description:"Ocurrió un error al exportar los datos.",type:"error"}}}async function p(){u.value={title:"Consultando datos",description:"Se están consultando los datos, la descarga comenzará en breve.",type:"info"};try{const n=localStorage.getItem("token"),a={id_contrato:U.value||0,id_entidad:w.value||0,consecutivoEntidad:G.value||void 0,organismoEntidad:s.value||void 0,num_consecutivo:z.value||0,fecha_desde:l.value||void 0,fecha_hasta:x.value||void 0,estado:$.value||void 0,id_trabajador_autorizado:h.value||0,id_usuario:k.value||0},i=await fetch(`${L.public.backendHost}/Factura/filterFacturas/1/${J.value}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:n,Accept:"application/json"},body:JSON.stringify(a)});if(i.status===401){u.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(i.status===403){u.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"};return}if(!i.ok){const m=await i.json();u.value={title:"Error al consultar datos",description:m.error||"Ocurrió un error al consultar los datos.",type:"error"};return}const _=await i.json(),F=[];_.data.forEach(m=>{m.productos&&m.productos.length>0&&m.productos.forEach(A=>{var ae,re,ne,ie,le,se,he,je,Me;F.push({"Num. Consecutivo Factura":m.num_consecutivo,"Fecha Factura":m.fecha?m.fecha.substring(0,10):"","Estado Factura":m.estado,"Creado por":((ae=m.usuario)==null?void 0:ae.nombre)||"","Cliente o Proveedor":((re=m.contrato)==null?void 0:re.ClienteOProveedor)||"",Contrato:((ne=m.contrato)==null?void 0:ne.num_consecutivo)||"","Tipo Contrato":((le=(ie=m.contrato)==null?void 0:ie.tipoContrato)==null?void 0:le.nombre)||"",Entidad:((he=(se=m.contrato)==null?void 0:se.entidad)==null?void 0:he.nombre)||"","Código Producto":A.codigo,"Nombre Producto":A.nombre,"Unidad de Medida":A.unidadMedida,"Nota Producto":A.nota,"Tipo Producto":A.tipoProducto,"Cantidad Existencia":A.cantidadExistencia,"Cantidad Facturada":((je=A.factura_producto)==null?void 0:je.cantidad)||"","Precio Venta":Number((Me=A.factura_producto)==null?void 0:Me.precioVenta).toFixed(2)||""})})});const T=W.json_to_sheet(F),I=W.book_new();W.book_append_sheet(I,T,"Facturas con Productos");const xe=new Date().toISOString().split("T")[0];$e(I,`facturas_con_productos_${xe}.xlsx`),u.value=null}catch(n){console.error("Error al exportar a Excel con productos:",n),u.value={title:"Error",description:"Ocurrió un error al exportar los datos con productos.",type:"error"}}}async function d(){u.value={title:"Consultando datos",description:"Se están consultando los datos, la descarga comenzará en breve.",type:"info"};try{const n=localStorage.getItem("token"),a={id_contrato:U.value||0,id_entidad:w.value||0,consecutivoEntidad:G.value||void 0,organismoEntidad:s.value||void 0,num_consecutivo:z.value||0,fecha_desde:l.value||void 0,fecha_hasta:x.value||void 0,estado:$.value||void 0,id_trabajador_autorizado:h.value||0,id_usuario:k.value||0},i=await fetch(`${L.public.backendHost}/Factura/filterFacturas/1/${J.value}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:n,Accept:"application/json"},body:JSON.stringify(a)});if(i.status===401){u.value={title:"Sesión Expirada",description:"Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",type:"warning"},localStorage.removeItem("token"),localStorage.removeItem("user"),setTimeout(()=>{E("/")},3e3);return}if(i.status===403){u.value={title:"Acceso Denegado",description:"No tienes permisos para realizar esta acción o acceder a esta información.",type:"error"};return}if(!i.ok){const m=await i.json();u.value={title:"Error al consultar datos",description:m.error||"Ocurrió un error al consultar los datos.",type:"error"};return}const _=await i.json(),F=[];_.data.forEach(m=>{m.servicio&&m.servicio.length>0&&m.servicio.forEach(A=>{var ae,re,ne,ie,le,se,he;F.push({"Num. Consecutivo Factura":m.num_consecutivo,"Fecha Factura":m.fecha?m.fecha.substring(0,10):"","Estado Factura":m.estado,"Creado por":((ae=m.usuario)==null?void 0:ae.nombre)||"","Cliente o Proveedor":((re=m.contrato)==null?void 0:re.ClienteOProveedor)||"",Contrato:((ne=m.contrato)==null?void 0:ne.num_consecutivo)||"","Tipo Contrato":((le=(ie=m.contrato)==null?void 0:ie.tipoContrato)==null?void 0:le.nombre)||"",Entidad:((he=(se=m.contrato)==null?void 0:se.entidad)==null?void 0:he.nombre)||"","Descripción Servicio":A.descripcion,"Importe Servicio":A.importe,"Cantidad Servicio":A.cantidad,"Unidad de Medida":A.unidadMedida})})});const T=W.json_to_sheet(F),I=W.book_new();W.book_append_sheet(I,T,"Facturas con Servicios");const xe=new Date().toISOString().split("T")[0];$e(I,`facturas_con_servicios_${xe}.xlsx`),u.value=null}catch(n){console.error("Error al exportar a Excel con servicios:",n),u.value={title:"Error",description:"Ocurrió un error al exportar los datos con servicios.",type:"error"}}}function oe(n){n.value=n,n&&n.contratos?f.value=n.contratos.map(a=>{var i;return{...a,displayLabel:`${a.num_consecutivo} - ${((i=a.tipoContrato)==null?void 0:i.nombre)||""} - ${a.ClienteOProveedor||""}`}}):f.value=[],U.value=""}Q(w,(n,a)=>{n&&!Z.value?Fe(n):n||(f.value=[],U.value="",Z.value=null)},{immediate:!0}),Ue(()=>{if(!localStorage.getItem("token")){E("/");return}ce()});const fe={render(){return pe("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-neutral",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[pe("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})])}};return(n,a)=>(S(),C("div",Ht,[j(Oe,{title:"Facturas - Contract Manager",description:"Lista y gestión de facturas en Contract Manager. Filtra, exporta y administra facturas.",canonical:"/facturas"}),j(De),u.value?(S(),C("div",Lt,[j(ze,{title:u.value.title,description:u.value.description,type:u.value.type,onClose:a[0]||(a[0]=i=>u.value=null),class:"pointer-events-auto"},null,8,["title","description","type"])])):K("",!0),B.value?(S(),C("div",Kt,[j(He,{title:"¿Estás seguro que deseas eliminar esta factura?",description:"Esta acción no se puede deshacer.",icon:fe,type:"warning",onConfirm:o,onClose:a[1]||(a[1]=i=>B.value=!1)})])):K("",!0),e("div",Gt,[e("div",Rt,[e("div",qt,[e("div",Jt,[a[13]||(a[13]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Consecutivo Entidad",-1)),M(e("input",{type:"text","onUpdate:modelValue":a[2]||(a[2]=i=>G.value=i),placeholder:"Ingrese consecutivo entidad...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:we(te,["enter"])},null,544),[[N,G.value]])]),e("div",Wt,[a[14]||(a[14]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Organismo Entidad",-1)),M(e("input",{type:"text","onUpdate:modelValue":a[3]||(a[3]=i=>s.value=i),placeholder:"Ingrese organismo entidad...",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:we(te,["enter"])},null,544),[[N,s.value]])]),e("div",Yt,[a[15]||(a[15]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Num. Consecutivo",-1)),M(e("input",{type:"number","onUpdate:modelValue":a[4]||(a[4]=i=>z.value=i),placeholder:"Número consecutivo",class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:we(te,["enter"])},null,544),[[N,z.value,void 0,{number:!0}]])]),e("div",Qt,[a[16]||(a[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Estado",-1)),j(_e,{modelValue:$.value,"onUpdate:modelValue":a[5]||(a[5]=i=>$.value=i),options:b.value,labelKey:"label",valueKey:"value",placeholder:"Seleccionar estado..."},null,8,["modelValue","options"])])]),e("div",Xt,[e("div",Zt,[a[17]||(a[17]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha Desde",-1)),M(e("input",{type:"date","onUpdate:modelValue":a[6]||(a[6]=i=>l.value=i),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:we(te,["enter"])},null,544),[[N,l.value]])]),e("div",eo,[a[18]||(a[18]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Fecha Hasta",-1)),M(e("input",{type:"date","onUpdate:modelValue":a[7]||(a[7]=i=>x.value=i),class:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary",onKeyup:we(te,["enter"])},null,544),[[N,x.value]])])]),e("div",to,[e("div",oo,[a[19]||(a[19]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Entidad por Nombre",-1)),j(me,{modelValue:w.value,"onUpdate:modelValue":a[8]||(a[8]=i=>w.value=i),endpoint:"/entidad/filter/1/10",method:"POST","search-key":"nombre","label-key":"nombre","value-key":"id_entidad",placeholder:"Buscar entidad por nombre...",onEntidadSeleccionada:oe},null,8,["modelValue"])]),e("div",ao,[a[20]||(a[20]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Contrato por número consecutivo",-1)),j(_e,{modelValue:U.value,"onUpdate:modelValue":a[9]||(a[9]=i=>U.value=i),options:f.value,labelKey:"displayLabel",valueKey:"id_contrato",disabled:!w.value,class:Y({"opacity-50":!w.value}),placeholder:"Seleccione primero una entidad..."},null,8,["modelValue","options","disabled","class"])]),e("div",ro,[a[21]||(a[21]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Trabajador Autorizado por Nombre",-1)),j(me,{modelValue:h.value,"onUpdate:modelValue":a[10]||(a[10]=i=>h.value=i),endpoint:"/trabajadorAutorizado/filter/1/10",method:"POST","search-key":"nombre","label-key":"nombre","value-key":"id_trabajador",placeholder:"Buscar trabajador por nombre..."},null,8,["modelValue"])]),e("div",no,[a[22]||(a[22]=e("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Usuario por Nombre",-1)),j(me,{modelValue:k.value,"onUpdate:modelValue":a[11]||(a[11]=i=>k.value=i),endpoint:"/Usuario/filterUsers",method:"POST","search-key":"nombre_usuario","label-key":"nombre_usuario","value-key":"id_usuario",placeholder:"Buscar usuario por nombre...","direct-data":!0},null,8,["modelValue"])])]),e("div",{class:"flex justify-end mt-4 gap-2 flex-wrap"},[e("button",{onClick:te,class:"px-6 py-2 bg-primary text-neutral rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors"}," Buscar "),e("button",{onClick:r,class:"px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors flex items-center"},[...a[23]||(a[23]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 12h2v2H7v-2zM11 12h2v2h-2v-2zM15 12h2v2h-2v-2z"})],-1),X(" Exportar a Excel ",-1)])]),e("button",{onClick:p,class:"px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors flex items-center"},[...a[24]||(a[24]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"})],-1),X(" Exportar a Excel con Productos ",-1)])]),e("button",{onClick:d,class:"px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors flex items-center"},[...a[25]||(a[25]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1),X(" Exportar a Excel con Servicios ",-1)])])])])]),e("div",io,[e("div",{class:"flex justify-between items-center mb-4"},[a[27]||(a[27]=e("h2",{class:"text-2xl font-bold"},"Facturas",-1)),e("button",{onClick:Ve,class:"px-4 py-2 bg-primary text-neutral rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary flex items-center"},[...a[26]||(a[26]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),X(" Nueva Factura ",-1)])])]),j(Be,{columns:ge,items:V.value,actions:Ce,"total-items":J.value,"items-per-page":g.value,"current-page":ee.value,"is-loading":ue.value,onPageChange:Se,onRowClick:ke},null,8,["items","total-items","items-per-page","current-page","is-loading"]),e("div",lo,[a[32]||(a[32]=e("h3",{class:"text-xl font-semibold mb-4"},"Resumen de Información Filtrada",-1)),e("div",so,[e("div",uo,[a[28]||(a[28]=e("div",{class:"text-sm font-medium"},"Suma: Servicios que los Proveedores han prestado",-1)),e("div",co,"Facturado: "+P((y.value.serviciosProveedoresFacturados??0).toFixed(2)),1),e("div",vo,"No Facturado: "+P(((y.value.serviciosProveedores??0).toFixed(2)-(y.value.serviciosProveedoresFacturados??0).toFixed(2)).toFixed(2)),1),e("div",po,"Total: "+P((y.value.serviciosProveedores??0).toFixed(2)),1)]),e("div",mo,[a[29]||(a[29]=e("div",{class:"text-sm font-medium"},"Suma: Servicios prestados a Clientes",-1)),e("div",go,"Facturado: "+P((y.value.serviciosClientesFacturados??0).toFixed(2)),1),e("div",bo,"No Facturado: "+P(((y.value.serviciosClientes??0).toFixed(2)-(y.value.serviciosClientesFacturados??0).toFixed(2)).toFixed(2)),1),e("div",fo,"Total: "+P((y.value.serviciosClientes??0).toFixed(2)),1)]),e("div",yo,[a[30]||(a[30]=e("div",{class:"text-sm font-medium"},"Suma: Productos comprados a Proveedores",-1)),e("div",xo,"Facturado: "+P((y.value.productosProveedorFacturados??0).toFixed(2)),1),e("div",ho,"No Facturado: "+P(((y.value.productosProveedor??0).toFixed(2)-(y.value.productosProveedorFacturados??0).toFixed(2)).toFixed(2)),1),e("div",wo,"Total: "+P((y.value.productosProveedor??0).toFixed(2)),1)]),e("div",ko,[a[31]||(a[31]=e("div",{class:"text-sm font-medium"},"Suma: Productos vendidos a Clientes",-1)),e("div",_o,"Facturado: "+P((y.value.productosClientesFacturados??0).toFixed(2)),1),e("div",Co,"No Facturado: "+P(((y.value.productosClientes??0).toFixed(2)-(y.value.productosClientesFacturados??0).toFixed(2)).toFixed(2)),1),e("div",So,"Total: "+P((y.value.productosClientes??0).toFixed(2)),1)])])])]),j(Bt,{modelValue:O.value,"onUpdate:modelValue":a[12]||(a[12]=i=>O.value=i),factura:R.value,"is-editing":q.value,"is-viewing":de.value,contratos:f.value,entidades:[],trabajadores:[],usuarios:[],onSubmit:t},null,8,["modelValue","factura","is-editing","is-viewing","contratos"])]))}};export{zo as default};
